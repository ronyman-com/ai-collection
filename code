
import sqlite3
import customtkinter as ctk
from tkinter import filedialog, ttk, messagebox
import tkinter as tk
from PIL import Image, ImageTk
import json
from datetime import datetime, timedelta
import os
import re



from modules.barber_manager import BarberManager
from modules.wisepad3 import WisePad3Manager 
from .database import DatabaseManager
from .config import ConfigManager
from .booking import BookingManager
from .membership import MembershipManager
from .payroll import PayrollManager
from .inventory import InventoryManager
from .reports import ReportGenerator

class HaircutStudioApp(ctk.CTk):
    def __init__(self):
        super().__init__()
        
        self.db = DatabaseManager()
        self.config = ConfigManager()
        self.booking_mgr = BookingManager(self.db)
        self.membership_mgr = MembershipManager(self.db)
        self.payroll_mgr = PayrollManager(self.db)
        self.inventory_mgr = InventoryManager(self.db)
        self.report_gen = ReportGenerator(self.db)
        self.barber_mgr = BarberManager(self.db)
     
        
        self.setup_window()
        self.setup_sidebar()
        self.setup_main_area()
        self.load_sample_data()

        # Initialize WisePad manager
        self.wisepad = WisePad3Manager(self.db)
        # Auto-connect to WisePad on startup
        self.after(1000, self.auto_connect_wisepad)

    def auto_connect_wisepad(self):
        """Auto-connect to WisePad on startup"""
        # Check if auto-connect is enabled in config
        try:
            with open('wisepad_config.json', 'r') as f:
                config = json.load(f)
                if config.get('last_connected_device'):
                    # Try to reconnect to last device
                    device_info = config['last_connected_device']
                    if device_info['type'] == 'bluetooth':
                        self.wisepad.connect_bluetooth(device_info['address'])
                    else:
                        self.wisepad.connect_serial(device_info['address'])
        except FileNotFoundError:
            pass
    
        
    def setup_window(self):
        self.title(f"{self.config.get('shop_name')} - Management System")
        self.geometry("1200x700")
        self.minsize(1000, 600)
        
        # Configure grid
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)
        
        # Set icon
        try:
            self.iconbitmap("assets/icons/barber.ico")
        except:
            pass
    ##############################################################################################################setup sidebar
    def setup_sidebar(self):
        self.sidebar = ctk.CTkFrame(self, width=200, corner_radius=0)
        self.sidebar.grid(row=0, column=0, sticky="nsew")
        
        # Logo
        self.logo_label = ctk.CTkLabel(
            self.sidebar,
            text=self.config.get('shop_name'),
            font=ctk.CTkFont(size=20, weight="bold")
        )
        self.logo_label.grid(row=0, column=0, padx=20, pady=(20, 10))
        
        # Navigation buttons
        self.nav_buttons = [
            ("üè† Dashboard", self.show_dashboard),
            ("‚úÇÔ∏è Booking", self.show_booking),
            ("üë• Clients", self.show_clients),
            ("üíà Barbers", self.show_barbers),
            ("üè™ Store", self.show_store),
            ("üí∞ Payments", self.show_payments),
            ("üí≥ Card Reader", self.show_wisepad),
            ("üìä Reports", self.show_reports),
            ("‚öôÔ∏è Settings", self.show_settings)
        ]
        
        for i, (text, command) in enumerate(self.nav_buttons, start=1):
            btn = ctk.CTkButton(
                self.sidebar,
                text=text,
                command=command,
                font=ctk.CTkFont(size=14),
                anchor="w",
                height=40
            )
            btn.grid(row=i, column=0, padx=10, pady=5, sticky="ew")
        
        # Quick check widget - placed after navigation buttons
        self.setup_quick_check_widget_in_sidebar()
        
        # Bottom status
        self.status_label = ctk.CTkLabel(
            self.sidebar,
            text="Ready",
            font=ctk.CTkFont(size=12)
        )
        # Position at the very bottom
        self.status_label.grid(row=100, column=0, padx=20, pady=20, sticky="s")

    def setup_quick_check_widget_in_sidebar(self):
        """Add quick membership check widget to sidebar"""
        # Calculate row position
        row_position = len(self.nav_buttons) + 1
        
        # Quick check frame
        quick_check_frame = ctk.CTkFrame(self.sidebar, fg_color="transparent")
        quick_check_frame.grid(row=row_position, column=0, padx=10, pady=(10, 20), sticky="ew")
        
        ctk.CTkLabel(quick_check_frame, text="Quick Check", 
                    font=ctk.CTkFont(size=12, weight="bold")).pack(anchor="w")
        
        # Phone input with validation
        self.quick_check_var = ctk.StringVar()
        phone_entry = ctk.CTkEntry(
            quick_check_frame, 
            placeholder_text="Enter 10-digit phone",
            textvariable=self.quick_check_var,
            height=35
        )
        phone_entry.pack(fill="x", pady=(5, 0))
        
        # Bind validation
        phone_entry.bind("<KeyRelease>", self.validate_phone_input)
        
        # Check button
        check_btn = ctk.CTkButton(
            quick_check_frame,
            text="Check Membership",
            command=self.quick_membership_check,
            height=35,
            fg_color="#28a745",
            hover_color="#218838"
        )
        check_btn.pack(fill="x", pady=5)
        
        # Status label for quick check
        self.quick_status_label = ctk.CTkLabel(
            quick_check_frame,
            text="",
            font=ctk.CTkFont(size=11),
            wraplength=180
        )
        self.quick_status_label.pack(pady=5)


    


    def show_wisepad(self):
        """Show WisePad management interface"""
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="WisePad 3 Payment Terminal",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Create notebook for tabs
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Payment tab
        payment_tab = ctk.CTkFrame(notebook)
        notebook.add(payment_tab, text="üí≥ Process Payment")
        
        # Terminal tab
        terminal_tab = ctk.CTkFrame(notebook)
        notebook.add(terminal_tab, text="‚öôÔ∏è Terminal Settings")
        
        # Transactions tab
        transactions_tab = ctk.CTkFrame(notebook)
        notebook.add(transactions_tab, text="üìä Transactions")
        
        self.build_payment_tab(payment_tab)
        self.build_terminal_tab(terminal_tab)
        self.build_transactions_tab(transactions_tab)
    
    def build_payment_tab(self, parent):
        """Build payment processing interface"""
        # Status indicator
        status_frame = ctk.CTkFrame(parent, height=80)
        status_frame.pack(fill="x", padx=20, pady=20)
        
        self.wisepad_status_label = ctk.CTkLabel(
            status_frame,
            text="Status: Not Connected",
            font=ctk.CTkFont(size=16, weight="bold")
        )
        self.wisepad_status_label.pack(pady=20)
        
        # Update status
        self.update_wisepad_status()
        
        # Payment form
        form_frame = ctk.CTkFrame(parent)
        form_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))
        
        # Amount
        ctk.CTkLabel(form_frame, text="Amount (AUD):", 
                    font=ctk.CTkFont(weight="bold")).grid(row=0, column=0, padx=10, pady=10, sticky="w")
        self.payment_amount = ctk.CTkEntry(form_frame, width=200)
        self.payment_amount.insert(0, "35.00")
        self.payment_amount.grid(row=0, column=1, padx=10, pady=10)
        
        # Description
        ctk.CTkLabel(form_frame, text="Description:", 
                    font=ctk.CTkFont(weight="bold")).grid(row=1, column=0, padx=10, pady=10, sticky="w")
        self.payment_desc = ctk.CTkEntry(form_frame, width=200)
        self.payment_desc.insert(0, "Haircut Service")
        self.payment_desc.grid(row=1, column=1, padx=10, pady=10)
        
        # Reference (optional)
        ctk.CTkLabel(form_frame, text="Reference:", 
                    font=ctk.CTkFont(weight="bold")).grid(row=2, column=0, padx=10, pady=10, sticky="w")
        self.payment_ref = ctk.CTkEntry(form_frame, width=200)
        self.payment_ref.grid(row=2, column=1, padx=10, pady=10)
        
        # Payment type
        ctk.CTkLabel(form_frame, text="Payment Type:", 
                    font=ctk.CTkFont(weight="bold")).grid(row=3, column=0, padx=10, pady=10, sticky="w")
        
        self.payment_type = ctk.StringVar(value="card")
        payment_types_frame = ctk.CTkFrame(form_frame, fg_color="transparent")
        payment_types_frame.grid(row=3, column=1, padx=10, pady=10, sticky="w")
        
        ctk.CTkRadioButton(payment_types_frame, text="üí≥ Card", 
                          variable=self.payment_type, value="card").pack(side="left", padx=5)
        ctk.CTkRadioButton(payment_types_frame, text="üì± Tap & Pay", 
                          variable=self.payment_type, value="tap").pack(side="left", padx=5)
        ctk.CTkRadioButton(payment_types_frame, text="ü§≥ Pay by Phone", 
                          variable=self.payment_type, value="phone").pack(side="left", padx=5)
        
        # Action buttons
        button_frame = ctk.CTkFrame(parent, fg_color="transparent")
        button_frame.pack(pady=20)
        
        ctk.CTkButton(
            button_frame,
            text="üí≥ Process Payment",
            command=self.process_wisepad_payment,
            width=200,
            height=50,
            font=ctk.CTkFont(size=14, weight="bold"),
            fg_color="#28a745",
            hover_color="#218838"
        ).pack(side="left", padx=10)
        
        ctk.CTkButton(
            button_frame,
            text="üßæ Print Test Receipt",
            command=self.print_test_receipt,
            width=150,
            height=40
        ).pack(side="left", padx=10)
        
        ctk.CTkButton(
            button_frame,
            text="üîÑ Settle Batch",
            command=self.settle_batch,
            width=150,
            height=40,
            fg_color="#ff9900"
        ).pack(side="left", padx=10)
        
        # Payment result display
        self.payment_result_frame = ctk.CTkFrame(parent, height=100, border_width=2)
        self.payment_result_frame.pack(fill="x", padx=20, pady=20)
        
        self.payment_result_label = ctk.CTkLabel(
            self.payment_result_frame,
            text="Payment result will appear here...",
            font=ctk.CTkFont(size=12)
        )
        self.payment_result_label.pack(pady=20)
    
    def build_terminal_tab(self, parent):
        """Build terminal settings interface"""
        # Configuration button
        config_frame = ctk.CTkFrame(parent)
        config_frame.pack(fill="x", padx=20, pady=20)
        
        ctk.CTkButton(
            config_frame,
            text="‚öôÔ∏è Configure WisePad",
            command=self.open_wisepad_config,
            width=200,
            height=40
        ).pack(pady=20)
        
        # Terminal info
        info_frame = ctk.CTkFrame(parent)
        info_frame.pack(fill="x", padx=20, pady=(0, 20))
        
        ctk.CTkLabel(info_frame, text="Terminal Information", 
                    font=ctk.CTkFont(weight="bold", size=14)).pack(pady=10)
        
        info_labels = [
            ("Merchant ID:", self.wisepad.merchant_id),
            ("Terminal ID:", self.wisepad.terminal_id),
            ("Connection:", "Connected" if self.wisepad.is_connected else "Disconnected"),
            ("Device Type:", self.wisepad.device['type'] if self.wisepad.device else "None")
        ]
        
        for i, (label, value) in enumerate(info_labels):
            row_frame = ctk.CTkFrame(info_frame, fg_color="transparent")
            row_frame.pack(fill="x", padx=20, pady=5)
            
            ctk.CTkLabel(row_frame, text=label, width=120).pack(side="left")
            ctk.CTkLabel(row_frame, text=value).pack(side="left")
        
        # Test buttons
        test_frame = ctk.CTkFrame(parent, fg_color="transparent")
        test_frame.pack(pady=20)
        
        ctk.CTkButton(
            test_frame,
            text="üîç Scan for Devices",
            command=self.scan_wisepad_devices,
            width=150
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            test_frame,
            text="üîå Test Connection",
            command=self.test_wisepad_connection,
            width=150
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            test_frame,
            text="üì° Reconnect",
            command=self.reconnect_wisepad,
            width=150
        ).pack(side="left", padx=5)
    
    def build_transactions_tab(self, parent):
        """Build transactions history interface"""
        # Toolbar
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=20, pady=20)
        
        ctk.CTkButton(toolbar, text="üîÑ Refresh", command=self.refresh_transactions).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="üìä Export", command=self.export_transactions).pack(side="left", padx=5)
        
        # Date filter
        filter_frame = ctk.CTkFrame(parent, fg_color="transparent")
        filter_frame.pack(fill="x", padx=20, pady=(0, 10))
        
        ctk.CTkLabel(filter_frame, text="Date Range:").pack(side="left", padx=5)
        
        self.transaction_from = ctk.CTkEntry(filter_frame, width=100, placeholder_text="YYYY-MM-DD")
        self.transaction_from.pack(side="left", padx=5)
        
        ctk.CTkLabel(filter_frame, text="to").pack(side="left", padx=5)
        
        self.transaction_to = ctk.CTkEntry(filter_frame, width=100, placeholder_text="YYYY-MM-DD")
        self.transaction_to.pack(side="left", padx=5)
        
        ctk.CTkButton(filter_frame, text="Filter", width=80).pack(side="left", padx=10)
        
        # Transactions table
        table_frame = ctk.CTkFrame(parent)
        table_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))
        
        columns = ("ID", "Date", "Amount", "Status", "Auth Code", "Description")
        self.transactions_tree = ttk.Treeview(table_frame, columns=columns, show="headings", height=10)
        
        column_widths = {
            "ID": 100, "Date": 120, "Amount": 80, 
            "Status": 100, "Auth Code": 100, "Description": 150
        }
        
        for col in columns:
            self.transactions_tree.heading(col, text=col)
            self.transactions_tree.column(col, width=column_widths.get(col, 100))
        
        scrollbar = ttk.Scrollbar(table_frame, orient="vertical", command=self.transactions_tree.yview)
        self.transactions_tree.configure(yscrollcommand=scrollbar.set)
        
        self.transactions_tree.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Load transactions
        self.load_transactions()
    
    def update_wisepad_status(self):
        """Update WisePad status display"""
        if self.wisepad.is_connected:
            self.wisepad_status_label.configure(
                text=f"‚úÖ Connected to WisePad 3",
                text_color="#28a745"
            )
        else:
            self.wisepad_status_label.configure(
                text="‚ùå Not Connected",
                text_color="#dc3545"
            )
    
    def process_wisepad_payment(self):
        """Process payment through WisePad"""
        if not self.wisepad.is_connected:
            messagebox.showerror("Not Connected", "Please connect to WisePad first")
            return
        
        try:
            amount = float(self.payment_amount.get())
            description = self.payment_desc.get()
            reference = self.payment_ref.get() or f"BOOK-{datetime.now().strftime('%Y%m%d%H%M')}"
            
            if amount <= 0:
                messagebox.showerror("Invalid Amount", "Please enter a valid amount")
                return
            
            # Update UI
            self.payment_result_label.configure(
                text="‚è≥ Processing payment... Please use the terminal",
                text_color="#17a2b8"
            )
            
            # Process payment
            transaction_id = self.wisepad.initiate_payment(
                amount=amount,
                description=description,
                reference=reference,
                callback=self.payment_callback
            )
            
            if transaction_id:
                self.log_transaction_start(transaction_id, amount, description)
            else:
                self.payment_result_label.configure(
                    text="‚ùå Failed to initiate payment",
                    text_color="#dc3545"
                )
                
        except ValueError:
            messagebox.showerror("Invalid Input", "Please enter a valid amount")
    
    def payment_callback(self, success, data):
        """Callback for payment processing"""
        if success:
            self.payment_result_label.configure(
                text=f"‚úÖ Payment Successful!\n"
                     f"Amount: ${data['amount']:.2f}\n"
                     f"Auth Code: {data.get('auth_code', 'N/A')}\n"
                     f"Transaction ID: {data['transaction_id']}",
                text_color="#28a745"
            )
            
            # Record successful transaction
            self.record_successful_transaction(data)
            
        else:
            self.payment_result_label.configure(
                text=f"‚ùå Payment Failed\n"
                     f"Error: {data.get('error', 'Unknown error')}",
                text_color="#dc3545"
            )
        
        # Update status
        self.update_wisepad_status()
    
    def log_transaction_start(self, transaction_id, amount, description):
        """Log transaction start to database"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO transactions 
            (transaction_type, amount, description, date, time, related_id, payment_method)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            'WisePad Payment',
            amount,
            description,
            datetime.now().strftime("%Y-%m-%d"),
            datetime.now().strftime("%H:%M:%S"),
            transaction_id,
            'WisePad Card'
        ))
        
        conn.commit()
        conn.close()
    
    def record_successful_transaction(self, data):
        """Record successful transaction to database"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        # Update transaction record
        cursor.execute('''
            UPDATE transactions 
            SET status = 'completed',
                auth_code = ?,
                completed_at = ?
            WHERE related_id = ?
        ''', (
            data.get('auth_code', ''),
            datetime.now().isoformat(),
            data['transaction_id']
        ))
        
        conn.commit()
        conn.close()
    
    def print_test_receipt(self):
        """Print test receipt"""
        if not self.wisepad.is_connected:
            messagebox.showerror("Not Connected", "Please connect to WisePad first")
            return
        
        receipt_lines = [
            "=== THAI BARBER STUDIO ===",
            "123 Barber Street, Sydney",
            "Phone: (02) 9876 5432",
            "",
            "TEST RECEIPT",
            f"Date: {datetime.now().strftime('%d/%m/%Y %H:%M')}",
            "",
            "Thank you for your business!",
            "",
            "This is a test receipt only",
            "No transaction has been processed"
        ]
        
        self.wisepad.print_custom_receipt(receipt_lines)
        messagebox.showinfo("Receipt", "Test receipt sent to printer")
    
    def settle_batch(self):
        """Settle daily batch"""
        if not self.wisepad.is_connected:
            messagebox.showerror("Not Connected", "Please connect to WisePad first")
            return
        
        response = messagebox.askyesno("Settle Batch", "Settle today's batch? This will close all transactions.")
        if response:
            if self.wisepad.settle_batch():
                messagebox.showinfo("Success", "Batch settled successfully")
            else:
                messagebox.showerror("Error", "Failed to settle batch")
    
    def open_wisepad_config(self):
        """Open WisePad configuration dialog"""
        dialog = WisePadConfigDialog(self, self.wisepad)
    
    def scan_wisepad_devices(self):
        """Scan for WisePad devices"""
        devices = self.wisepad.discover_devices()
        
        if devices:
            device_list = "\n".join([f"{d['name']} ({d['address']})" for d in devices])
            messagebox.showinfo("Devices Found", f"Found {len(devices)} device(s):\n\n{device_list}")
        else:
            messagebox.showinfo("No Devices", "No WisePad devices found")
    
    def test_wisepad_connection(self):
        """Test WisePad connection"""
        if self.wisepad.test_connection():
            messagebox.showinfo("Connection Test", "‚úÖ Connection successful!")
            self.update_wisepad_status()
        else:
            messagebox.showerror("Connection Test", "‚ùå Connection failed")
    
    def reconnect_wisepad(self):
        """Reconnect to WisePad"""
        self.wisepad.disconnect()
        self.wisepad.is_connected = False
        self.update_wisepad_status()
        
        # Try to reconnect after 1 second
        self.after(1000, self.auto_connect_wisepad)
        messagebox.showinfo("Reconnect", "Attempting to reconnect...")
    
    def load_transactions(self):
        """Load transactions from database - FIXED VERSION"""
        # Clear existing items
        for item in self.transactions_tree.get_children():
            self.transactions_tree.delete(item)
        
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        try:
            # First check if status column exists
            cursor.execute("PRAGMA table_info(transactions)")
            columns_info = cursor.fetchall()
            column_names = [col[1] for col in columns_info]
            
            # Build query based on available columns
            if 'status' in column_names:
                # Full query with status column
                cursor.execute('''
                    SELECT 
                        COALESCE(related_id, 'N/A') as trans_id,
                        date || ' ' || COALESCE(time, '') as datetime,
                        amount,
                        CASE 
                            WHEN status = 'completed' THEN '‚úÖ Success'
                            WHEN status = 'cancelled' THEN '‚ùå Cancelled' 
                            WHEN status = 'failed' THEN '‚ùå Failed'
                            WHEN status = 'pending' THEN '‚è≥ Pending'
                            ELSE COALESCE(status, '‚è≥ Pending')
                        END as status_display,
                        COALESCE(auth_code, 'N/A') as auth,
                        COALESCE(description, '') as desc
                    FROM transactions 
                    WHERE transaction_type = 'WisePad Payment'
                    ORDER BY date DESC, time DESC
                    LIMIT 50
                ''')
            else:
                # Basic query without status column
                cursor.execute('''
                    SELECT 
                        COALESCE(related_id, 'N/A') as trans_id,
                        date || ' ' || COALESCE(time, '') as datetime,
                        amount,
                        '‚è≥ Pending' as status_display,
                        COALESCE(auth_code, 'N/A') as auth,
                        COALESCE(description, '') as desc
                    FROM transactions 
                    WHERE transaction_type = 'WisePad Payment'
                    ORDER BY date DESC, time DESC
                    LIMIT 50
                ''')
            
        except Exception as e:
            # Fallback to simplest query
            self.logger.error(f"Error loading transactions: {e}")
            cursor.execute('''
                SELECT 
                    COALESCE(related_id, 'N/A'),
                    date || ' ' || COALESCE(time, ''),
                    amount,
                    '‚è≥ Pending',
                    'N/A',
                    COALESCE(description, '')
                FROM transactions 
                WHERE transaction_type LIKE '%WisePad%' OR transaction_type LIKE '%Payment%'
                ORDER BY date DESC, time DESC
                LIMIT 50
            ''')
        
        transactions = cursor.fetchall()
        conn.close()
        
        # Add data to treeview
        for transaction in transactions:
            self.transactions_tree.insert("", "end", values=transaction)
    
    def refresh_transactions(self):
        """Refresh transactions list"""
        self.load_transactions()
    
    def export_transactions(self):
        """Export transactions to CSV"""
        filename = f"wisepad_transactions_{datetime.now().strftime('%Y%m%d')}.csv"
        
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT date, time, amount, description, auth_code, related_id, status
            FROM transactions 
            WHERE transaction_type = 'WisePad Payment'
            ORDER BY date DESC, time DESC
        ''')
        
        import csv
        with open(filename, 'w', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(['Date', 'Time', 'Amount', 'Description', 'Auth Code', 'Transaction ID', 'Status'])
            
            for row in cursor.fetchall():
                writer.writerow(row)
        
        conn.close()
        messagebox.showinfo("Export Complete", f"Transactions exported to {filename}")
    
    def setup_main_area(self):
        self.main_frame = ctk.CTkFrame(self)
        self.main_frame.grid(row=0, column=1, sticky="nsew", padx=10, pady=10)
        self.main_frame.grid_columnconfigure(0, weight=1)
        self.main_frame.grid_rowconfigure(0, weight=1)
        
        # Dashboard as default view
        self.show_dashboard()




    ################################################  add membership verification
    
    
    def validate_phone_input(self, event=None):
        """Validate phone number input - must be 10 digits"""
        phone = self.quick_check_var.get()
        
        # Remove non-digits
        digits = re.sub(r'\D', '', phone)
        
        # Limit to 10 digits
        if len(digits) > 10:
            digits = digits[:10]
        
        # Format as XXXXXXXXXX (no spaces)
        self.quick_check_var.set(digits)
        
        # Change border color based on validation
        widget = event.widget if event else None
        if widget:
            if len(digits) == 10 and digits.isdigit():
                widget.configure(border_color="#28a745", border_width=2)
            elif len(digits) > 0:
                widget.configure(border_color="#dc3545", border_width=2)
            else:
                widget.configure(border_color="#6c757d", border_width=1)
        
        return len(digits) == 10 and digits.isdigit()
    
    def quick_membership_check(self):
        """Quick check membership by phone number"""
        phone = self.quick_check_var.get().strip()
        
        # Validate phone
        if not self.validate_phone_input():
            self.quick_status_label.configure(
                text="‚ùå Invalid phone number\nMust be 10 digits",
                text_color="#dc3545"
            )
            return
        
        # Check database for client with this phone
        client_info = self.get_client_by_phone(phone)
        
        if client_info:
            # Display client info
            client_id, name, membership_level, visits_count, last_visit = client_info
            
            # Get membership details
            membership_info = self.membership_mgr.get_client_membership_info(name)
            
            if membership_info:
                status_text = self.format_membership_status(membership_info, name, visits_count)
                self.quick_status_label.configure(
                    text=status_text,
                    text_color="#28a745" if not membership_info['is_expired'] else "#dc3545"
                )
                
                # Show notification
                self.show_membership_notification(membership_info, name)
            else:
                self.quick_status_label.configure(
                    text=f"‚úÖ {name}\nNo active membership\nVisits: {visits_count}",
                    text_color="#6c757d"
                )
        else:
            self.quick_status_label.configure(
                text="‚ùå No client found\nwith this phone number",
                text_color="#dc3545"
            )
            
            # Offer to add new client
            response = messagebox.askyesno(
                "New Client",
                "No client found with this phone number.\nWould you like to add them as a new client?"
            )
            if response:
                self.add_client_from_quick_check(phone)
    
    def format_membership_status(self, membership_info, name, visits_count):
        """Format membership status for display"""
        if membership_info['is_expired']:
            status_icon = "‚ùå"
            status_text = f"EXPIRED ({membership_info['membership_level']})"
        else:
            status_icon = "‚úÖ"
            status_text = f"{membership_info['membership_level']}"
        
        text = f"{status_icon} {name}\n"
        text += f"Status: {status_text}\n"
        text += f"Visits: {visits_count}"
        
        if membership_info['visits_for_free']:
            remaining = membership_info['visits_remaining']
            text += f" ({remaining} to free visit)\n"
        else:
            text += "\n"
        
        text += f"Discount: {membership_info['discount_percent']}%"
        
        # Add expiry info if applicable
        if membership_info['duration_days']:
            days_left = membership_info['duration_days'] - membership_info['days_since_join']
            if days_left > 0:
                text += f"\nExpires in: {days_left} days"
        
        return text
    
    def show_membership_notification(self, membership_info, client_name):
        """Show notification popup for special memberships"""
        if membership_info['visits_remaining'] == 1:
            # Next visit is free!
            messagebox.showinfo(
                "üéâ Free Visit Alert!",
                f"{client_name} is eligible for a FREE visit on their next appointment!\n\n"
                f"Current visits: {membership_info['visits_count']}\n"
                f"Next visit will be FREE! üéÅ"
            )
        elif membership_info['visits_remaining'] <= 3:
            # Close to free visit
            messagebox.showinfo(
                "üåü Almost There!",
                f"{client_name} needs {membership_info['visits_remaining']} more visits "
                f"for a FREE haircut!\n\n"
                f"Current visits: {membership_info['visits_count']}"
            )
    
    def add_client_from_quick_check(self, phone):
        """Quick add client dialog from phone check"""
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add New Client")
        dialog.geometry("400x350")
        dialog.transient(self)
        dialog.grab_set()
        
        # Center dialog
        dialog.update_idletasks()
        width = dialog.winfo_width()
        height = dialog.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        dialog.geometry(f'{width}x{height}+{x}+{y}')
        
        ctk.CTkLabel(dialog, text="Add New Client", 
                    font=ctk.CTkFont(size=18, weight="bold")).pack(pady=10)
        
        # Form
        fields_frame = ctk.CTkFrame(dialog)
        fields_frame.pack(fill="both", expand=True, padx=20, pady=10)
        
        # Name
        ctk.CTkLabel(fields_frame, text="Full Name:").grid(row=0, column=0, padx=5, pady=5, sticky="w")
        name_entry = ctk.CTkEntry(fields_frame, width=250)
        name_entry.grid(row=0, column=1, padx=5, pady=5)
        
        # Phone (pre-filled)
        ctk.CTkLabel(fields_frame, text="Phone:").grid(row=1, column=0, padx=5, pady=5, sticky="w")
        phone_entry = ctk.CTkEntry(fields_frame, width=250)
        phone_entry.insert(0, phone)
        phone_entry.grid(row=1, column=1, padx=5, pady=5)
        
        # Email
        ctk.CTkLabel(fields_frame, text="Email (optional):").grid(row=2, column=0, padx=5, pady=5, sticky="w")
        email_entry = ctk.CTkEntry(fields_frame, width=250)
        email_entry.grid(row=2, column=1, padx=5, pady=5)
        
        # Membership Plan
        ctk.CTkLabel(fields_frame, text="Membership Plan:").grid(row=3, column=0, padx=5, pady=5, sticky="w")
        plans = ["Regular", "VIP Plan", "Gold Plan", "Student Plan"]
        plan_combo = ctk.CTkComboBox(fields_frame, values=plans, width=250)
        plan_combo.grid(row=3, column=1, padx=5, pady=5)
        
        def save_new_client():
            name = name_entry.get().strip()
            phone_num = phone_entry.get().strip()
            email = email_entry.get().strip()
            plan = plan_combo.get()
            
            if not name:
                messagebox.showerror("Error", "Name is required!")
                return
            
            if not self.validate_phone_format(phone_num):
                messagebox.showerror("Error", "Phone must be 10 digits!")
                return
            
            # Save to database
            try:
                conn = self.db.get_connection()
                cursor = conn.cursor()
                
                cursor.execute('''
                    INSERT INTO clients (name, phone, email, membership_level, join_date)
                    VALUES (?, ?, ?, ?, ?)
                ''', (name, phone_num, email, plan, datetime.now().strftime("%Y-%m-%d")))
                
                conn.commit()
                conn.close()
                
                dialog.destroy()
                messagebox.showinfo("Success", f"Client {name} added successfully!")
                
                # Update quick check status
                self.quick_status_label.configure(
                    text=f"‚úÖ {name} added!\nPlan: {plan}",
                    text_color="#28a745"
                )
                
                # Clear phone field for next check
                self.quick_check_var.set("")
                
            except sqlite3.IntegrityError:
                messagebox.showerror("Error", "Phone number already exists!")
        
        # Buttons
        btn_frame = ctk.CTkFrame(dialog)
        btn_frame.pack(pady=20)
        
        ctk.CTkButton(btn_frame, text="Save", command=save_new_client,
                     width=100).pack(side="left", padx=10)
        ctk.CTkButton(btn_frame, text="Cancel", command=dialog.destroy,
                     width=100, fg_color="#6c757d").pack(side="left", padx=10)
    
    def validate_phone_format(self, phone):
        """Validate phone number format"""
        digits = re.sub(r'\D', '', phone)
        return len(digits) == 10 and digits.isdigit()
    
    def get_client_by_phone(self, phone):
        """Get client info by phone number"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        # Clean phone number for search
        search_phone = re.sub(r'\D', '', phone)
        
        cursor.execute('''
            SELECT id, name, membership_level, visits_count, last_visit
            FROM clients 
            WHERE REPLACE(REPLACE(phone, ' ', ''), '-', '') = ?
        ''', (search_phone,))
        
        client = cursor.fetchone()
        conn.close()
        return client
    
        
    ##########################################
    
    def show_dashboard(self):
        self.clear_main_frame()
        
        # Configure grid for better layout
        self.main_frame.grid_columnconfigure(0, weight=1)
        self.main_frame.grid_columnconfigure(1, weight=1)
        self.main_frame.grid_columnconfigure(2, weight=1)
        
        # Dashboard title with quick check
        title_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        title_frame.grid(row=0, column=0, columnspan=3, pady=(0, 20), sticky="ew")
        
        # Dashboard title
        ctk.CTkLabel(
            title_frame,
            text="Dashboard",
            font=ctk.CTkFont(size=24, weight="bold")
        ).pack(side="left")
        
        # Define phone_var and quick_check_frame at the class level or locally
        phone_var = ctk.StringVar()
        
        # Quick phone check widget for dashboard
        quick_check_frame = ctk.CTkFrame(title_frame, fg_color="transparent")
        quick_check_frame.pack(side="right", padx=10)
        
        phone_entry = ctk.CTkEntry(
            quick_check_frame,
            placeholder_text="Check by phone...",
            textvariable=phone_var,
            width=150,
            height=35
        )
        phone_entry.pack(side="left", padx=(0, 5))
        
        def quick_dashboard_check():
            phone = phone_var.get()
            if self.validate_phone_format(phone):
                client_info = self.get_client_by_phone(phone)
                if client_info:
                    client_id, name, membership_level, visits_count, last_visit = client_info
                    # Get detailed membership info
                    membership_info = self.membership_mgr.get_client_membership_info(name)
                    
                    # Create custom dialog
                    dialog = ctk.CTkToplevel(self)
                    dialog.title(f"Membership Status - {name}")
                    dialog.geometry("400x350")
                    dialog.transient(self)
                    dialog.grab_set()
                    
                    # Center dialog
                    dialog.update_idletasks()
                    width = dialog.winfo_width()
                    height = dialog.winfo_height()
                    x = (self.winfo_screenwidth() // 2) - (width // 2)
                    y = (self.winfo_screenheight() // 2) - (height // 2)
                    dialog.geometry(f'{width}x{height}+{x}+{y}')
                    
                    # Header
                    header = ctk.CTkFrame(dialog, fg_color="#3a7ebf", height=50)
                    header.pack(fill="x", pady=(0, 20))
                    ctk.CTkLabel(header, text="Membership Status", 
                            font=ctk.CTkFont(size=18, weight="bold"),
                            text_color="white").pack(pady=15)
                    
                    # Client info
                    info_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    info_frame.pack(fill="both", expand=True, padx=20, pady=10)
                    
                    info_rows = [
                        ("üë§ Client:", name),
                        ("üì± Phone:", phone),
                        ("üìÖ Last Visit:", last_visit or "Never"),
                        ("üìä Total Visits:", str(visits_count))
                    ]
                    
                    for label, value in info_rows:
                        row_frame = ctk.CTkFrame(info_frame, fg_color="transparent")
                        row_frame.pack(fill="x", pady=5)
                        ctk.CTkLabel(row_frame, text=label, font=ctk.CTkFont(weight="bold"), 
                                width=100).pack(side="left", padx=5)
                        ctk.CTkLabel(row_frame, text=value).pack(side="left", padx=5)
                    
                    # Membership status
                    status_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    status_frame.pack(fill="x", padx=20, pady=10)
                    
                    if membership_info:
                        if membership_info.get('is_expired', False):
                            status_color = "#dc3545"
                            status_text = f"‚ùå EXPIRED ({membership_level})"
                        else:
                            status_color = "#28a745"
                            status_text = f"‚úÖ ACTIVE ({membership_level})"
                        
                        ctk.CTkLabel(status_frame, text="Status:", 
                                font=ctk.CTkFont(weight="bold")).pack(side="left", padx=5)
                        ctk.CTkLabel(status_frame, text=status_text,
                                text_color=status_color).pack(side="left", padx=5)
                        
                        # Membership details
                        details_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                        details_frame.pack(fill="x", padx=20, pady=10)
                        
                        discount = membership_info.get('discount_percent', 0)
                        if discount:
                            ctk.CTkLabel(details_frame, text=f"üéØ Discount: {discount}%").pack(anchor="w")
                        
                        visits_for_free = membership_info.get('visits_for_free')
                        if visits_for_free:
                            remaining = membership_info.get('visits_remaining', 0)
                            if remaining == 1:
                                ctk.CTkLabel(details_frame, text="üéâ Next visit is FREE!", 
                                        text_color="#ff9900", font=ctk.CTkFont(weight="bold")).pack(anchor="w", pady=5)
                            elif remaining <= 3:
                                ctk.CTkLabel(details_frame, text=f"‚≠ê {remaining} visits until FREE", 
                                        text_color="#17a2b8").pack(anchor="w")
                    
                    # Action buttons
                    btn_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    btn_frame.pack(pady=20)
                    
                    ctk.CTkButton(btn_frame, text="Book Appointment", 
                                command=lambda: self.book_for_client(client_id, dialog),
                                width=120).pack(side="left", padx=5)
                    ctk.CTkButton(btn_frame, text="Close", 
                                command=dialog.destroy,
                                width=80).pack(side="left", padx=5)
                    
                    # Clear phone field
                    phone_var.set("")
                else:
                    # Client not found - offer to add
                    response = messagebox.askyesno(
                        "Client Not Found",
                        f"No client found with phone: {phone}\n\nWould you like to add as new client?"
                    )
                    if response:
                        self.add_client_from_quick_check(phone)
            else:
                messagebox.showerror("Invalid Phone", "Please enter a valid 10-digit Australian phone number")
        
        ctk.CTkButton(
            quick_check_frame,
            text="üîç Quick Check",
            width=120,
            height=35,
            command=quick_dashboard_check,
            fg_color="#17a2b8",
            hover_color="#138496"
        ).pack(side="left")
        
        # Today's summary
        today = datetime.now().strftime("%Y-%m-%d")
        today_stats = self.booking_mgr.get_daily_stats(today)
        
        # Stats cards
        stats_frame = ctk.CTkFrame(self.main_frame)
        stats_frame.grid(row=1, column=0, columnspan=3, pady=(0, 20), sticky="ew")
        
        stats = [
            ("Today's Bookings", f"{today_stats.get('total_bookings', 0)}", "#3a7ebf"),
            ("Today's Revenue", f"${today_stats.get('total_revenue', 0):.2f}", "#28a745"),
            ("Active Clients", f"{self.membership_mgr.get_active_clients_count()}", "#9c4dcc"),
            ("Available Barbers", f"{len(self.get_available_barbers())}", "#6c757d")
        ]
        
        for i, (label, value, color) in enumerate(stats):
            card = ctk.CTkFrame(stats_frame, width=200, height=100, corner_radius=10)
            card.grid(row=0, column=i, padx=10, pady=10, sticky="nsew")
            
            # Colored header
            header = ctk.CTkFrame(card, fg_color=color, height=30, corner_radius=10)
            header.pack(fill="x", pady=(0, 10))
            ctk.CTkLabel(header, text=label, text_color="white",
                        font=ctk.CTkFont(size=11)).pack(pady=5)
            
            ctk.CTkLabel(card, text=value, font=ctk.CTkFont(size=28, weight="bold")).pack(pady=(5, 0))
        
        # Quick actions
        actions_frame = ctk.CTkFrame(self.main_frame)
        actions_frame.grid(row=2, column=0, columnspan=2, pady=20, sticky="nsew")
        
        ctk.CTkLabel(actions_frame, text="‚ö° Quick Actions", 
                    font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=10)
        
        action_buttons = [
            ("üìÖ New Booking", self.show_booking, "#3a7ebf"),
            ("üë§ Add Client", self.add_client_dialog, "#28a745"),
            ("üíà Add Barber", self.add_barber_dialog, "#6c757d"),
            ("üí∞ Process Payment", self.process_payment_dialog, "#ff9900"),
            ("üì¶ Restock", self.restock_dialog, "#fd7e14"),
            ("üìä Daily Report", self.generate_daily_report, "#9c4dcc")
        ]
        
        for text, command, color in action_buttons:
            btn = ctk.CTkButton(actions_frame, text=text, command=command, 
                            fg_color=color, hover_color=self.darken_color(color),
                            height=40, corner_radius=8)
            btn.pack(fill="x", padx=10, pady=5, anchor="w")
        
        # Recent bookings
        recent_frame = ctk.CTkFrame(self.main_frame)
        recent_frame.grid(row=3, column=0, columnspan=3, pady=20, sticky="nsew")
        
        ctk.CTkLabel(recent_frame, text="üìã Recent Bookings", 
                    font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=10)
        
        # Create treeview for recent bookings
        columns = ("ID", "Client", "Barber", "Service", "Time", "Status")
        tree = ttk.Treeview(recent_frame, columns=columns, show="headings", height=6)
        
        column_widths = {
            "ID": 50, "Client": 120, "Barber": 100, 
            "Service": 120, "Time": 80, "Status": 80
        }
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=column_widths.get(col, 100))
        
        # Add scrollbar
        scrollbar = ttk.Scrollbar(recent_frame, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side="left", fill="both", expand=True, padx=(10, 0), pady=(0, 10))
        scrollbar.pack(side="right", fill="y", pady=(0, 10))
        
        # Get recent bookings using updated booking manager
        recent_bookings_data = self.booking_mgr.get_recent_bookings(limit=10)
        
        # Add data to treeview
        for booking in recent_bookings_data:
            tree.insert("", "end", values=(
                booking.get('id', ''),
                booking.get('client_name', ''),
                booking.get('barber_name', ''),
                booking.get('service', ''),
                booking.get('time', ''),
                booking.get('status', '')
            ))
        
        # Color code status
        tree.tag_configure('Confirmed', background='#d4edda')
        tree.tag_configure('Pending', background='#fff3cd')
        tree.tag_configure('Completed', background='#d1ecf1')
        tree.tag_configure('Cancelled', background='#f8d7da')
        
        # Configure grid weights
        stats_frame.grid_columnconfigure(0, weight=1)
        stats_frame.grid_columnconfigure(1, weight=1)
        stats_frame.grid_columnconfigure(2, weight=1)
        stats_frame.grid_columnconfigure(3, weight=1)
        
        actions_frame.grid_columnconfigure(0, weight=1)
        recent_frame.grid_columnconfigure(0, weight=1)


    ########################################################## barber area
    def show_barbers(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Barber Management",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Create notebook for barber tabs
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # All Barbers tab
        all_barbers_frame = ctk.CTkFrame(notebook)
        notebook.add(all_barbers_frame, text="All Barbers")
        self.build_all_barbers_tab(all_barbers_frame)
        
        # Schedule tab
        schedule_frame = ctk.CTkFrame(notebook)
        notebook.add(schedule_frame, text="Barber Schedule")
        self.build_schedule_tab(schedule_frame)
        
        # Performance tab
        performance_frame = ctk.CTkFrame(notebook)
        notebook.add(performance_frame, text="Performance")
        self.build_performance_tab(performance_frame)

    def build_all_barbers_tab(self, parent):
        # Toolbar
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        # Add barber button
        ctk.CTkButton(toolbar, text="Add Barber", command=self.add_barber_dialog,
                    width=120).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Edit", width=80).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Set Inactive", width=100,
                    fg_color="#d44040", hover_color="#b33030").pack(side="left", padx=5)
        
        # Barber cards display
        barbers_frame = ctk.CTkFrame(parent)
        barbers_frame.pack(fill="both", expand=True, padx=10, pady=(0, 10))
        
        # Get barbers data
        barbers = self.get_all_barbers()
        
        if not barbers:
            ctk.CTkLabel(barbers_frame, text="No barbers found. Add your first barber!",
                        font=ctk.CTkFont(size=16)).pack(pady=50)
            return
        
        # Create a canvas with scrollbar for barber cards
        canvas = tk.Canvas(barbers_frame, bg="#2b2b2b", highlightthickness=0)
        scrollbar = ttk.Scrollbar(barbers_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = ctk.CTkFrame(canvas)
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Display barber cards
        row, col = 0, 0
        for barber in barbers:
            barber_id, name, specialization, photo_path, hourly_rate, commission_rate, is_active, join_date = barber
            
            # Create barber card
            card = ctk.CTkFrame(
                scrollable_frame,
                width=200,
                height=280,
                border_width=2,
                border_color="#3a7ebf" if is_active else "#6c757d",
                corner_radius=10
            )
            card.grid(row=row, column=col, padx=15, pady=15)
            
            # Status indicator
            status_color = "#28a745" if is_active else "#6c757d"
            status_text = "Active" if is_active else "Inactive"
            
            status_frame = ctk.CTkFrame(card, fg_color=status_color, height=30)
            status_frame.pack(fill="x", pady=(0, 10))
            ctk.CTkLabel(status_frame, text=status_text, text_color="white").pack(pady=5)
            
            # Barber photo placeholder
            photo_frame = ctk.CTkFrame(card, width=80, height=80, corner_radius=40)
            photo_frame.pack(pady=10)
            ctk.CTkLabel(photo_frame, text="üë®‚Äçüíº", font=ctk.CTkFont(size=40)).pack(pady=10)
            
            # Barber info
            ctk.CTkLabel(card, text=name, font=ctk.CTkFont(size=16, weight="bold")).pack()
            ctk.CTkLabel(card, text=specialization).pack(pady=2)
            ctk.CTkLabel(card, text=f"${hourly_rate}/hr").pack(pady=2)
            ctk.CTkLabel(card, text=f"{commission_rate}% commission").pack(pady=2)
            
            # Join date
            ctk.CTkLabel(card, text=f"Since: {join_date}", 
                        font=ctk.CTkFont(size=10)).pack(pady=(10, 0))
            
            # Action buttons
            btn_frame = ctk.CTkFrame(card, fg_color="transparent")
            btn_frame.pack(pady=10)
            
            ctk.CTkButton(btn_frame, text="View", width=60,
                        command=lambda b=barber_id: self.view_barber_details(b)).pack(side="left", padx=2)
            ctk.CTkButton(btn_frame, text="Edit", width=60,
                        command=lambda b=barber_id: self.edit_barber(b)).pack(side="left", padx=2)
            
            col += 1
            if col > 2:  # 3 cards per row
                col = 0
                row += 1
        
        # Configure grid columns
        for i in range(3):
            scrollable_frame.grid_columnconfigure(i, weight=1)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

    


    def darken_color(self, color, factor=0.8):
        """
        Darken a hex color for hover effect
        
        Args:
            color: Hex color string (e.g., "#3a7ebf")
            factor: Darkening factor (0-1, where 1 is no change, 0.5 is 50% darker)
        
        Returns:
            Darkened hex color string
        """
        try:
            # Remove # if present
            if color.startswith('#'):
                color = color[1:]
            
            # Convert to RGB
            r = int(color[0:2], 16)
            g = int(color[2:4], 16)
            b = int(color[4:6], 16)
            
            # Darken each component
            r = max(0, int(r * factor))
            g = max(0, int(g * factor))
            b = max(0, int(b * factor))
            
            # Convert back to hex
            return f"#{r:02x}{g:02x}{b:02x}"
        
        except (ValueError, IndexError):
            # If color parsing fails, return a default darker color
            return "#1f6aa5"  # Default dark blue

    ############################################################################# new add


    # Add these methods to the HaircutStudioApp class:

    def show_clients(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Client Management",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Create notebook for client tabs
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # All Clients tab
        all_clients_frame = ctk.CTkFrame(notebook)
        notebook.add(all_clients_frame, text="All Clients")
        self.build_all_clients_tab(all_clients_frame)
        
        # Membership tab
        membership_frame = ctk.CTkFrame(notebook)
        notebook.add(membership_frame, text="Membership Plans")
        self.build_membership_tab(membership_frame)
        
        # VIP Clients tab
        vip_frame = ctk.CTkFrame(notebook)
        notebook.add(vip_frame, text="VIP Clients")
        self.build_vip_clients_tab(vip_frame)

    def build_all_clients_tab(self, parent):
        # Toolbar
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        # Search bar
        search_frame = ctk.CTkFrame(toolbar, fg_color="transparent")
        search_frame.pack(side="left", padx=5)
        
        ctk.CTkLabel(search_frame, text="Search:").pack(side="left", padx=5)
        search_entry = ctk.CTkEntry(search_frame, width=200, placeholder_text="Client name or phone...")
        search_entry.pack(side="left", padx=5)
        
        # Action buttons
        btn_frame = ctk.CTkFrame(toolbar, fg_color="transparent")
        btn_frame.pack(side="right", padx=5)
        
        ctk.CTkButton(btn_frame, text="Add Client", command=self.add_client_dialog,
                    width=100).pack(side="left", padx=2)
        ctk.CTkButton(btn_frame, text="Edit", width=80).pack(side="left", padx=2)
        ctk.CTkButton(btn_frame, text="Delete", width=80,
                    fg_color="#d44040", hover_color="#b33030").pack(side="left", padx=2)
        ctk.CTkButton(btn_frame, text="Export", width=80).pack(side="left", padx=2)
        
        # Clients table
        table_frame = ctk.CTkFrame(parent)
        table_frame.pack(fill="both", expand=True, padx=10, pady=(0, 10))
        
        # Create treeview with scrollbar
        columns = ("ID", "Name", "Phone", "Email", "Membership", "Visits", "Last Visit", "Join Date")
        tree = ttk.Treeview(table_frame, columns=columns, show="headings", height=15)
        
        # Configure columns
        column_widths = {
            "ID": 50, "Name": 150, "Phone": 120, "Email": 180,
            "Membership": 100, "Visits": 70, "Last Visit": 100, "Join Date": 100
        }
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=column_widths.get(col, 100))
        
        # Add scrollbar
        scrollbar = ttk.Scrollbar(table_frame, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side="left", fill="both", expand=True, padx=(0, 0), pady=5)
        scrollbar.pack(side="right", fill="y", pady=5)
        
        # Load clients data
        clients = self.get_all_clients()
        for client in clients:
            tree.insert("", "end", values=client, tags=(client[4].lower(),))
        
        # Color code by membership
        tree.tag_configure('vip', background='#fff3cd')
        tree.tag_configure('gold', background='#fff3cd')
        tree.tag_configure('regular', background='white')
        
        # Bind selection
        tree.bind("<<TreeviewSelect>>", self.on_client_select)


         # Add phone validation to search
        def validate_search_phone(event=None):
            search_text = search_entry.get()
            if len(search_text) >= 10:
                # Check if it looks like a phone number
                digits = re.sub(r'\D', '', search_text)
                if len(digits) >= 10:
                    # Format as XXX-XXX-XXXX
                    if len(digits) == 10:
                        formatted = f"{digits[:3]}-{digits[3:6]}-{digits[6:10]}"
                        search_entry.delete(0, tk.END)
                        search_entry.insert(0, formatted)
        
        search_entry.bind("<KeyRelease>", validate_search_phone)
        
        # Add quick check button in toolbar
        quick_check_btn = ctk.CTkButton(
            btn_frame, 
            text="üîç Quick Check", 
            width=100,
            command=self.open_quick_check_modal,
            fg_color="#17a2b8",
            hover_color="#138496"
        )
        quick_check_btn.pack(side="left", padx=2)
    
    def open_quick_check_modal(self):
        """Open quick check modal from clients tab"""
        # Create a modal dialog for quick check
        modal = ctk.CTkToplevel(self)
        modal.title("Quick Membership Check")
        modal.geometry("350x200")
        modal.transient(self)
        modal.grab_set()
        
        # Center modal
        modal.update_idletasks()
        width = modal.winfo_width()
        height = modal.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        modal.geometry(f'{width}x{height}+{x}+{y}')
        
        # Phone input
        ctk.CTkLabel(modal, text="Enter Phone Number:", 
                    font=ctk.CTkFont(weight="bold")).pack(pady=10)
        
        phone_var = ctk.StringVar()
        phone_entry = ctk.CTkEntry(
            modal, 
            placeholder_text="04XX XXX XXX",
            textvariable=phone_var,
            width=250
        )
        phone_entry.pack(pady=5)
        
        # Result label
        result_label = ctk.CTkLabel(modal, text="", font=ctk.CTkFont(size=11))
        result_label.pack(pady=10)
        
        def check_phone():
            phone = phone_var.get().strip()
            if not self.validate_phone_format(phone):
                result_label.configure(
                    text="‚ùå Invalid phone number\nMust be 10 digits",
                    text_color="#dc3545"
                )
                return
            
            client_info = self.get_client_by_phone(phone)
            if client_info:
                client_id, name, membership_level, visits_count, last_visit = client_info
                result_label.configure(
                    text=f"‚úÖ {name}\nPlan: {membership_level}\nVisits: {visits_count}",
                    text_color="#28a745"
                )
            else:
                result_label.configure(
                    text="‚ùå No client found",
                    text_color="#dc3545"
                )
        
        # Buttons
        btn_frame = ctk.CTkFrame(modal, fg_color="transparent")
        btn_frame.pack(pady=10)
        
        ctk.CTkButton(btn_frame, text="Check", command=check_phone,
                    width=100).pack(side="left", padx=5)
        ctk.CTkButton(btn_frame, text="Close", command=modal.destroy,
                    width=100, fg_color="#6c757d").pack(side="left", padx=5)
    
    def build_membership_tab(self, parent):
        # Membership plans management
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkButton(toolbar, text="Add New Plan", command=self.add_membership_plan_dialog,
                    width=120).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Edit Plan", width=100).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Delete Plan", width=100,
                    fg_color="#d44040", hover_color="#b33030").pack(side="left", padx=5)
        
        # Membership plans display
        plans_frame = ctk.CTkFrame(parent)
        plans_frame.pack(fill="both", expand=True, padx=10, pady=(0, 10))
        
        # Get membership plans
        plans = self.get_membership_plans()
        
        row, col = 0, 0
        for plan in plans:
            plan_id, plan_name, visits_for_free, discount_percent, price, duration_days = plan
            
            plan_card = ctk.CTkFrame(
                plans_frame,
                width=200,
                height=180,
                border_width=2,
                border_color="#3a7ebf",
                corner_radius=10
            )
            plan_card.grid(row=row, column=col, padx=15, pady=15)
            
            # Plan header
            header_frame = ctk.CTkFrame(plan_card, fg_color="#3a7ebf", height=40)
            header_frame.pack(fill="x", pady=(0, 10))
            
            ctk.CTkLabel(header_frame, text=plan_name, 
                        font=ctk.CTkFont(weight="bold", size=14),
                        text_color="white").pack(pady=10)
            
            # Plan details
            details_frame = ctk.CTkFrame(plan_card, fg_color="transparent")
            details_frame.pack(padx=10, pady=5)
            
            details = [
                f"Free after: {visits_for_free} visits",
                f"Discount: {discount_percent}%",
                f"Price: ${price:.2f}",
                f"Duration: {duration_days} days"
            ]
            
            for detail in details:
                ctk.CTkLabel(details_frame, text=detail).pack(anchor="w", pady=2)
            
            # Select button
            ctk.CTkButton(plan_card, text="Select", width=80,
                        command=lambda p=plan_id: self.assign_membership_plan(p)).pack(pady=10)
            
            col += 1
            if col > 2:
                col = 0
                row += 1
        
        # Make grid responsive
        for i in range(3):
            plans_frame.grid_columnconfigure(i, weight=1)

    def build_vip_clients_tab(self, parent):
        # VIP clients display
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkLabel(toolbar, text="VIP Clients - Special Benefits").pack(side="left", padx=10)
        
        # VIP clients statistics
        stats_frame = ctk.CTkFrame(parent)
        stats_frame.pack(fill="x", padx=10, pady=10)
        
        stats = self.get_vip_clients_stats()
        
        stats_labels = [
            ("Total VIP Clients", f"{stats['total_vip']}"),
            ("Average Visits", f"{stats['avg_visits']:.1f}"),
            ("Monthly Revenue", f"${stats['monthly_revenue']:.2f}"),
            ("Top Spender", f"${stats['top_spender']:.2f}")
        ]
        
        for i, (label, value) in enumerate(stats_labels):
            stat_frame = ctk.CTkFrame(stats_frame, width=150, height=80)
            stat_frame.grid(row=0, column=i, padx=10, pady=10)
            
            ctk.CTkLabel(stat_frame, text=value, 
                        font=ctk.CTkFont(size=20, weight="bold")).pack(pady=(15, 5))
            ctk.CTkLabel(stat_frame, text=label, 
                        font=ctk.CTkFont(size=10)).pack()
        
        # VIP clients list
        list_frame = ctk.CTkFrame(parent)
        list_frame.pack(fill="both", expand=True, padx=10, pady=(0, 10))
        
        columns = ("Name", "Phone", "Plan", "Visits", "Total Spent", "Last Visit")
        tree = ttk.Treeview(list_frame, columns=columns, show="headings", height=10)
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=120)
        
        scrollbar = ttk.Scrollbar(list_frame, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side="left", fill="both", expand=True, padx=(0, 0), pady=5)
        scrollbar.pack(side="right", fill="y", pady=5)
        
        # Load VIP clients
        vip_clients = self.get_vip_clients()
        for client in vip_clients:
            tree.insert("", "end", values=client)


################################################################################################# barber area
    def edit_barber(self, barber_id):
        """Open instant edit barber dialog"""
        barber_info = self.barber_mgr.get_barber(barber_id)
        if barber_info:
            self.open_barber_editor(barber_info, "Edit Barber")
    
    def view_barber_details(self, barber_id):
        # Open barber details dialog
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM barbers WHERE id = ?', (barber_id,))
        barber = cursor.fetchone()
        conn.close()
        
        if barber:
            dialog = ctk.CTkToplevel(self)
            dialog.title(f"Barber Details - {barber[1]}")
            dialog.geometry("500x400")
            
            # Display barber details - FIXED: Convert to float before formatting
            details = [
                ("Name", barber[1]),
                ("Specialization", barber[2]),
                ("Hourly Rate", f"${float(barber[3]):.2f}"),  # Convert to float
                ("Commission Rate", f"{float(barber[4]):.1f}%"),  # Convert to float
                ("Status", "Active" if barber[10] else "Inactive"),
                ("Join Date", barber[11])
            ]
            
            for i, (label, value) in enumerate(details):
                frame = ctk.CTkFrame(dialog)
                frame.pack(fill="x", padx=20, pady=5)
                
                ctk.CTkLabel(frame, text=label, font=ctk.CTkFont(weight="bold"), 
                            width=150).pack(side="left", padx=10)
                ctk.CTkLabel(frame, text=str(value)).pack(side="left", padx=10)
            
            # Barber statistics
            stats_frame = ctk.CTkFrame(dialog)
            stats_frame.pack(fill="x", padx=20, pady=20)
            
            ctk.CTkLabel(stats_frame, text="This Week's Statistics", 
                        font=ctk.CTkFont(weight="bold", size=14)).pack(pady=10)
            
            # Get real stats from database
            today = datetime.now().strftime("%Y-%m-%d")
            week_ago = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
            
            conn = self.db.get_connection()
            cursor = conn.cursor()
            
            # Get weekly bookings count
            cursor.execute('''
                SELECT COUNT(*), SUM(price) 
                FROM bookings 
                WHERE barber_id = ? 
                AND booking_date BETWEEN ? AND ?
                AND status IN ('Confirmed', 'Completed')
            ''', (barber_id, week_ago, today))
            
            stats_result = cursor.fetchone()
            bookings_count = stats_result[0] if stats_result[0] else 0
            weekly_revenue = float(stats_result[1]) if stats_result[1] else 0.0
            
            # Calculate hours worked (estimate: 30 min per booking)
            hours_worked = bookings_count * 0.5
            
            # Calculate commission
            commission_rate = float(barber[4])
            commission = weekly_revenue * (commission_rate / 100)
            
            conn.close()
            
            stats = [
                ("Bookings", f"{bookings_count}"),
                ("Revenue", f"${weekly_revenue:.2f}"),
                ("Hours Worked", f"{hours_worked:.1f}"),
                ("Commission", f"${commission:.2f}")
            ]
            
            for i, (label, value) in enumerate(stats):
                stat_card = ctk.CTkFrame(stats_frame, width=100, height=80)
                stat_card.grid(row=1, column=i, padx=10, pady=10)
                
                ctk.CTkLabel(stat_card, text=value, 
                            font=ctk.CTkFont(size=16, weight="bold")).pack(pady=(15, 5))
                ctk.CTkLabel(stat_card, text=label).pack()
            
            # Configure grid
            for i in range(4):
                stats_frame.grid_columnconfigure(i, weight=1)
            
            # Add action buttons
            btn_frame = ctk.CTkFrame(dialog)
            btn_frame.pack(fill="x", padx=20, pady=10)
            
            ctk.CTkButton(
                btn_frame,
                text="‚úèÔ∏è Edit Barber",
                command=lambda: self.edit_barber(barber_id, dialog),
                width=120
            ).pack(side="left", padx=5)
            
            ctk.CTkButton(
                btn_frame,
                text="üìÖ Book Now",
                command=lambda: self.book_for_barber(barber_id, dialog),
                width=120
            ).pack(side="left", padx=5)
            
            ctk.CTkButton(
                btn_frame,
                text="Close",
                command=dialog.destroy,
                width=80,
                fg_color="#6c757d"
            ).pack(side="right", padx=5)
    
    def open_barber_details(self, barber_info):
        """Open barber details dialog with edit button"""
        dialog = ctk.CTkToplevel(self)
        dialog.title(f"Barber Details - {barber_info['name']}")
        dialog.geometry("600x700")
        dialog.transient(self)
        dialog.grab_set()
        
        # Center dialog
        self.center_window(dialog)
        
        # Create notebook for tabs
        notebook = ttk.Notebook(dialog)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Profile tab
        profile_tab = ctk.CTkFrame(notebook)
        notebook.add(profile_tab, text="üë§ Profile")
        
        # Schedule tab
        schedule_tab = ctk.CTkFrame(notebook)
        notebook.add(schedule_tab, text="üìÖ Schedule")
        
        # Stats tab
        stats_tab = ctk.CTkFrame(notebook)
        notebook.add(stats_tab, text="üìä Statistics")
        
        self.build_profile_tab(profile_tab, barber_info)
        self.build_schedule_tab(schedule_tab, barber_info)
        self.build_stats_tab(stats_tab, barber_info)
        
        # Action buttons
        btn_frame = ctk.CTkFrame(dialog)
        btn_frame.pack(fill="x", padx=20, pady=10)
        
        ctk.CTkButton(
            btn_frame,
            text="‚úèÔ∏è Edit Barber",
            command=lambda: self.open_barber_editor(barber_info, "Edit Barber", dialog),
            width=120,
            fg_color="#3a7ebf"
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            btn_frame,
            text="üìÖ Book Appointment",
            command=lambda: self.book_for_barber(barber_info['id'], dialog),
            width=140
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            btn_frame,
            text="üìä View Report",
            command=lambda: self.generate_barber_report(barber_info['id'], dialog),
            width=120
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            btn_frame,
            text="Close",
            command=dialog.destroy,
            width=100,
            fg_color="#6c757d"
        ).pack(side="right", padx=5)
    
    def build_profile_tab(self, parent, barber_info):
        """Build profile tab"""
        # Profile header with photo
        header_frame = ctk.CTkFrame(parent)
        header_frame.pack(fill="x", padx=20, pady=20)
        
        # Photo frame
        photo_frame = ctk.CTkFrame(header_frame, width=100, height=100)
        photo_frame.pack(side="left", padx=(0, 20))
        
        # Load photo if exists
        photo_path = barber_info.get('photo_path', '')
        if photo_path and os.path.exists(photo_path):
            try:
                img = Image.open(photo_path)
                img = img.resize((100, 100), Image.Resampling.LANCZOS)
                photo_img = ImageTk.PhotoImage(img)
                
                photo_label = tk.Label(photo_frame, image=photo_img, bg="#2b2b2b")
                photo_label.image = photo_img  # Keep reference
                photo_label.pack()
            except:
                # Default icon
                ctk.CTkLabel(photo_frame, text="üë®‚Äçüíº", 
                           font=ctk.CTkFont(size=40)).pack(pady=20)
        else:
            ctk.CTkLabel(photo_frame, text="üë®‚Äçüíº", 
                       font=ctk.CTkFont(size=40)).pack(pady=20)
        
        # Name and specialization
        info_frame = ctk.CTkFrame(header_frame, fg_color="transparent")
        info_frame.pack(side="left", fill="both", expand=True)
        
        ctk.CTkLabel(
            info_frame,
            text=barber_info['name'],
            font=ctk.CTkFont(size=24, weight="bold")
        ).pack(anchor="w")
        
        ctk.CTkLabel(
            info_frame,
            text=barber_info['specialization'],
            font=ctk.CTkFont(size=16),
            text_color="#6c757d"
        ).pack(anchor="w", pady=(0, 10))
        
        # Status badge
        status_color = "#28a745" if barber_info['is_active'] else "#dc3545"
        status_text = "‚úÖ Active" if barber_info['is_active'] else "‚ùå Inactive"
        
        status_frame = ctk.CTkFrame(info_frame, fg_color=status_color, 
                                   corner_radius=10, height=30)
        status_frame.pack(anchor="w")
        ctk.CTkLabel(status_frame, text=status_text, text_color="white",
                    font=ctk.CTkFont(weight="bold")).pack(padx=10, pady=5)
        
        # Details section
        details_frame = ctk.CTkFrame(parent)
        details_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))
        
        details = [
            ("üí∞ Hourly Rate:", f"${barber_info['hourly_rate']:.2f}"),
            ("üìä Commission:", f"{barber_info['commission_rate']}%"),
            ("üì± Phone:", barber_info.get('phone', 'Not provided')),
            ("üìß Email:", barber_info.get('email', 'Not provided')),
            ("üìç Address:", barber_info.get('address', 'Not provided')),
            ("üìÖ Joined:", barber_info.get('join_date', 'Unknown')),
            ("üìù Notes:", barber_info.get('notes', 'No notes'))
        ]
        
        for label, value in details:
            row_frame = ctk.CTkFrame(details_frame, fg_color="transparent")
            row_frame.pack(fill="x", pady=5)
            
            ctk.CTkLabel(row_frame, text=label, 
                        font=ctk.CTkFont(weight="bold"),
                        width=120).pack(side="left", padx=5)
            ctk.CTkLabel(row_frame, text=value, 
                        wraplength=400).pack(side="left", padx=5)
    
    def build_schedule_tab(self, parent, barber_info):
        """Build schedule tab"""
        # Weekly schedule
        schedule_frame = ctk.CTkFrame(parent)
        schedule_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        ctk.CTkLabel(
            schedule_frame,
            text="Weekly Schedule",
            font=ctk.CTkFont(size=16, weight="bold")
        ).pack(pady=(0, 15))
        
        days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 
                'Friday', 'Saturday', 'Sunday']
        
        schedule_data = {day.lower(): {'start': '09:00', 'end': '18:00', 'working': True} 
                        for day in days}
        
        # Update with actual schedule
        for day_schedule in barber_info.get('schedule', []):
            day = day_schedule[0]
            schedule_data[day] = {
                'start': day_schedule[1],
                'end': day_schedule[2],
                'working': bool(day_schedule[3])
            }
        
        for i, day in enumerate(days):
            day_lower = day.lower()
            schedule = schedule_data[day_lower]
            
            day_frame = ctk.CTkFrame(schedule_frame, height=50)
            day_frame.pack(fill="x", pady=2)
            
            # Day label
            ctk.CTkLabel(day_frame, text=day, 
                        font=ctk.CTkFont(weight="bold"),
                        width=100).pack(side="left", padx=10)
            
            if schedule['working']:
                # Working hours
                hours_frame = ctk.CTkFrame(day_frame, fg_color="#d4edda", 
                                          height=30, corner_radius=5)
                hours_frame.pack(side="left", padx=5)
                ctk.CTkLabel(hours_frame, 
                           text=f"{schedule['start']} - {schedule['end']}",
                           text_color="#155724").pack(pady=5)
            else:
                # Day off
                off_frame = ctk.CTkFrame(day_frame, fg_color="#f8d7da", 
                                        height=30, corner_radius=5)
                off_frame.pack(side="left", padx=5)
                ctk.CTkLabel(off_frame, text="DAY OFF",
                           text_color="#721c24").pack(pady=5)
        
        # Time off section
        time_off_frame = ctk.CTkFrame(parent)
        time_off_frame.pack(fill="x", padx=20, pady=(0, 20))
        
        ctk.CTkLabel(
            time_off_frame,
            text="Upcoming Time Off",
            font=ctk.CTkFont(size=14, weight="bold")
        ).pack(pady=(10, 5))
        
        time_off = barber_info.get('time_off', [])
        if time_off:
            for date, reason in time_off:
                off_frame = ctk.CTkFrame(time_off_frame, fg_color="transparent")
                off_frame.pack(fill="x", pady=2)
                
                ctk.CTkLabel(off_frame, text=date, 
                           width=100).pack(side="left", padx=5)
                ctk.CTkLabel(off_frame, text=reason).pack(side="left", padx=5)
        else:
            ctk.CTkLabel(time_off_frame, text="No upcoming time off",
                       text_color="#6c757d").pack(pady=10)
    
    def build_stats_tab(self, parent, barber_info):
        """Build statistics tab"""
        stats_frame = ctk.CTkFrame(parent)
        stats_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        ctk.CTkLabel(
            stats_frame,
            text="This Week's Performance",
            font=ctk.CTkFont(size=16, weight="bold")
        ).pack(pady=(0, 20))
        
        # Stats cards
        stats_cards = [
            ("Bookings", f"{barber_info['weekly_bookings']}", "#3a7ebf"),
            ("Revenue", f"${barber_info['weekly_revenue']:.2f}", "#28a745"),
            ("Avg per Booking", f"${barber_info['weekly_revenue']/max(barber_info['weekly_bookings'], 1):.2f}", "#ff9900"),
            ("Commission", f"${barber_info['weekly_revenue'] * (barber_info['commission_rate']/100):.2f}", "#9c4dcc")
        ]
        
        row_frame = ctk.CTkFrame(stats_frame, fg_color="transparent")
        row_frame.pack(pady=10)
        
        for i, (label, value, color) in enumerate(stats_cards):
            card = ctk.CTkFrame(row_frame, width=120, height=100)
            card.grid(row=0, column=i, padx=5)
            
            header = ctk.CTkFrame(card, fg_color=color, height=30)
            header.pack(fill="x")
            ctk.CTkLabel(header, text=label, text_color="white",
                        font=ctk.CTkFont(size=10)).pack(pady=5)
            
            ctk.CTkLabel(card, text=value, 
                        font=ctk.CTkFont(size=18, weight="bold")).pack(pady=15)
        
        # Configure grid
        for i in range(4):
            row_frame.grid_columnconfigure(i, weight=1)
    
    def open_barber_editor(self, barber_info=None, title="Add Barber", parent_dialog=None):
        """Open barber editor dialog"""
        if parent_dialog:
            parent_dialog.destroy()
        
        dialog = ctk.CTkToplevel(self)
        dialog.title(title)
        dialog.geometry("700x800")
        dialog.transient(self)
        dialog.grab_set()
        
        self.center_window(dialog)
        
        # Store photo path
        self.current_photo_path = barber_info.get('photo_path', '') if barber_info else ''
        
        # Create notebook
        notebook = ttk.Notebook(dialog)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Basic info tab
        basic_tab = ctk.CTkFrame(notebook)
        notebook.add(basic_tab, text="Basic Info")
        
        # Schedule tab
        schedule_tab = ctk.CTkFrame(notebook)
        notebook.add(schedule_tab, text="Schedule")
        
        # Commission tab
        commission_tab = ctk.CTkFrame(notebook)
        notebook.add(commission_tab, text="Commission")
        
        self.build_basic_info_tab(basic_tab, barber_info)
        self.build_schedule_editor_tab(schedule_tab, barber_info)
        self.build_commission_tab(commission_tab, barber_info)
        
        # Action buttons
        btn_frame = ctk.CTkFrame(dialog)
        btn_frame.pack(fill="x", padx=20, pady=10)
        
        ctk.CTkButton(
            btn_frame,
            text="üíæ Save Barber",
            command=lambda: self.save_barber(barber_info, dialog) if barber_info 
                           else self.create_new_barber(dialog),
            width=120,
            fg_color="#28a745",
            font=ctk.CTkFont(weight="bold")
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            btn_frame,
            text="Cancel",
            command=dialog.destroy,
            width=100,
            fg_color="#6c757d"
        ).pack(side="right", padx=5)
    
    def build_basic_info_tab(self, parent, barber_info):
        """Build basic information tab"""
        scroll_frame = ctk.CTkScrollableFrame(parent)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Photo upload
        photo_frame = ctk.CTkFrame(scroll_frame)
        photo_frame.pack(fill="x", pady=10)
        
        ctk.CTkLabel(photo_frame, text="Profile Photo:", 
                    font=ctk.CTkFont(weight="bold")).pack(anchor="w", padx=10, pady=5)
        
        photo_btn_frame = ctk.CTkFrame(photo_frame, fg_color="transparent")
        photo_btn_frame.pack(padx=10, pady=5)
        
        ctk.CTkButton(
            photo_btn_frame,
            text="üì∑ Upload Photo",
            command=self.upload_barber_photo,
            width=120
        ).pack(side="left", padx=5)
        
        self.photo_preview_label = ctk.CTkLabel(photo_btn_frame, text="No photo selected")
        self.photo_preview_label.pack(side="left", padx=10)
        
        # Basic info form
        fields = [
            ("Name", "name", "text", True),
            ("Specialization", "specialization", "combo", True),
            ("Phone", "phone", "text", False),
            ("Email", "email", "text", False),
            ("Address", "address", "text", False),
            ("Hourly Rate (AUD)", "hourly_rate", "number", True),
            ("Notes", "notes", "textarea", False)
        ]
        
        self.barber_fields = {}
        
        for i, (label, field_name, field_type, required) in enumerate(fields):
            frame = ctk.CTkFrame(scroll_frame)
            frame.pack(fill="x", pady=5, padx=10)
            
            ctk.CTkLabel(frame, text=label + (" *" if required else ""), 
                        font=ctk.CTkFont(weight="bold" if required else "normal"),
                        width=150).pack(side="left", padx=10)
            
            if field_type == "text":
                entry = ctk.CTkEntry(frame, width=300)
                if barber_info and field_name in barber_info:
                    entry.insert(0, str(barber_info[field_name]))
                entry.pack(side="left", padx=10)
                self.barber_fields[field_name] = entry
                
            elif field_type == "number":
                entry = ctk.CTkEntry(frame, width=300)
                if barber_info and field_name in barber_info:
                    entry.insert(0, str(barber_info[field_name]))
                else:
                    entry.insert(0, "35.00")
                entry.pack(side="left", padx=10)
                self.barber_fields[field_name] = entry
                
            elif field_type == "combo":
                specializations = ["Men's Haircut", "Women's Styling", "Beard Specialist", 
                                 "Color Expert", "Kids Haircut", "Senior Stylist", "All Services"]
                combo = ctk.CTkComboBox(frame, values=specializations, width=300)
                if barber_info and barber_info[field_name]:
                    combo.set(barber_info[field_name])
                else:
                    combo.set("Men's Haircut")
                combo.pack(side="left", padx=10)
                self.barber_fields[field_name] = combo
                
            elif field_type == "textarea":
                textbox = ctk.CTkTextbox(frame, width=300, height=80)
                if barber_info and barber_info[field_name]:
                    textbox.insert("1.0", barber_info[field_name])
                textbox.pack(side="left", padx=10)
                self.barber_fields[field_name] = textbox
        
        # Status checkbox
        status_frame = ctk.CTkFrame(scroll_frame)
        status_frame.pack(fill="x", pady=10, padx=10)
        
        self.active_var = ctk.BooleanVar(value=barber_info.get('is_active', True) if barber_info else True)
        ctk.CTkCheckBox(
            status_frame,
            text="Active Barber",
            variable=self.active_var,
            font=ctk.CTkFont(weight="bold")
        ).pack(side="left", padx=10)

    def build_all_barbers_tab(self, parent):
        # Toolbar
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        # Add barber button
        ctk.CTkButton(toolbar, text="Add Barber", command=self.add_barber_dialog,
                    width=120).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Edit", width=80).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Set Inactive", width=100,
                    fg_color="#d44040", hover_color="#b33030").pack(side="left", padx=5)
        
        # Barber cards display
        barbers_frame = ctk.CTkFrame(parent)
        barbers_frame.pack(fill="both", expand=True, padx=10, pady=(0, 10))
        
        # Get barbers data
        barbers = self.get_all_barbers()
        
        if not barbers:
            ctk.CTkLabel(barbers_frame, text="No barbers found. Add your first barber!",
                        font=ctk.CTkFont(size=16)).pack(pady=50)
            return
        
        # Create a canvas with scrollbar for barber cards
        canvas = tk.Canvas(barbers_frame, bg="#2b2b2b", highlightthickness=0)
        scrollbar = ttk.Scrollbar(barbers_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = ctk.CTkFrame(canvas)
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Display barber cards
        row, col = 0, 0
        for barber in barbers:
            barber_id, name, specialization, photo_path, hourly_rate, commission_rate, is_active, join_date = barber
            
            # Create barber card
            card = ctk.CTkFrame(
                scrollable_frame,
                width=200,
                height=280,
                border_width=2,
                border_color="#3a7ebf" if is_active else "#6c757d",
                corner_radius=10
            )
            card.grid(row=row, column=col, padx=15, pady=15)
            
            # Status indicator
            status_color = "#28a745" if is_active else "#6c757d"
            status_text = "Active" if is_active else "Inactive"
            
            status_frame = ctk.CTkFrame(card, fg_color=status_color, height=30)
            status_frame.pack(fill="x", pady=(0, 10))
            ctk.CTkLabel(status_frame, text=status_text, text_color="white").pack(pady=5)
            
            # Barber photo placeholder
            photo_frame = ctk.CTkFrame(card, width=80, height=80, corner_radius=40)
            photo_frame.pack(pady=10)
            ctk.CTkLabel(photo_frame, text="üë®‚Äçüíº", font=ctk.CTkFont(size=40)).pack(pady=10)
            
            # Barber info
            ctk.CTkLabel(card, text=name, font=ctk.CTkFont(size=16, weight="bold")).pack()
            ctk.CTkLabel(card, text=specialization).pack(pady=2)
            ctk.CTkLabel(card, text=f"${hourly_rate}/hr").pack(pady=2)
            ctk.CTkLabel(card, text=f"{commission_rate}% commission").pack(pady=2)
            
            # Join date
            ctk.CTkLabel(card, text=f"Since: {join_date}", 
                        font=ctk.CTkFont(size=10)).pack(pady=(10, 0))
            
            # Action buttons
            # Update action buttons
            btn_frame = ctk.CTkFrame(card, fg_color="transparent")
            btn_frame.pack(pady=10)
            
            ctk.CTkButton(btn_frame, text="üëÅÔ∏è View", width=60,
                        command=lambda b=barber_id: self.view_barber_details(b)).pack(side="left", padx=2)
            ctk.CTkButton(btn_frame, text="‚úèÔ∏è Edit", width=60,
                        command=lambda b=barber_id: self.edit_barber(b)).pack(side="left", padx=2)
            ctk.CTkButton(btn_frame, text="üìÖ Book", width=60,
                        command=lambda b=barber_id: self.book_for_barber(b)).pack(side="left", padx=2)
            
            col += 1
            if col > 2:  # 3 cards per row
                col = 0
                row += 1
        
        # Configure grid columns
        for i in range(3):
            scrollable_frame.grid_columnconfigure(i, weight=1)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

    
    
    
    def build_schedule_editor_tab(self, parent, barber_info):
        """Build schedule editor tab"""
        scroll_frame = ctk.CTkScrollableFrame(parent)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        ctk.CTkLabel(
            scroll_frame,
            text="Weekly Working Schedule",
            font=ctk.CTkFont(size=14, weight="bold")
        ).pack(pady=(0, 15))
        
        days = [
            ('Monday', 'monday'),
            ('Tuesday', 'tuesday'),
            ('Wednesday', 'wednesday'),
            ('Thursday', 'thursday'),
            ('Friday', 'friday'),
            ('Saturday', 'saturday'),
            ('Sunday', 'sunday')
        ]
        
        self.schedule_fields = {}
        
        # Get existing schedule
        existing_schedule = {}
        if barber_info and 'schedule' in barber_info:
            for day_schedule in barber_info['schedule']:
                existing_schedule[day_schedule[0]] = {
                    'start': day_schedule[1],
                    'end': day_schedule[2],
                    'working': bool(day_schedule[3])
                }
        
        for day_name, day_key in days:
            day_frame = ctk.CTkFrame(scroll_frame)
            day_frame.pack(fill="x", pady=5)
            
            # Day label and checkbox
            header_frame = ctk.CTkFrame(day_frame, fg_color="transparent")
            header_frame.pack(fill="x", pady=5)
            
            working_var = ctk.BooleanVar(value=existing_schedule.get(day_key, {}).get('working', 
                                      day_key != 'sunday'))  # Sunday off by default
            checkbox = ctk.CTkCheckBox(
                header_frame,
                text=day_name,
                variable=working_var,
                width=100
            )
            checkbox.pack(side="left", padx=10)
            
            # Time entries
            time_frame = ctk.CTkFrame(header_frame, fg_color="transparent")
            time_frame.pack(side="left", padx=20)
            
            ctk.CTkLabel(time_frame, text="From:").pack(side="left", padx=5)
            start_entry = ctk.CTkEntry(time_frame, width=80)
            start_entry.insert(0, existing_schedule.get(day_key, {}).get('start', '09:00'))
            start_entry.pack(side="left", padx=5)
            
            ctk.CTkLabel(time_frame, text="To:").pack(side="left", padx=5)
            end_entry = ctk.CTkEntry(time_frame, width=80)
            end_entry.insert(0, existing_schedule.get(day_key, {}).get('end', '18:00'))
            end_entry.pack(side="left", padx=5)
            
            self.schedule_fields[day_key] = {
                'working': working_var,
                'start': start_entry,
                'end': end_entry
            }
    
    def build_commission_tab(self, parent, barber_info):
        """Build commission settings tab"""
        frame = ctk.CTkFrame(parent)
        frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        ctk.CTkLabel(
            frame,
            text="Commission Settings",
            font=ctk.CTkFont(size=16, weight="bold")
        ).pack(pady=(0, 20))
        
        # Commission rate
        rate_frame = ctk.CTkFrame(frame, fg_color="transparent")
        rate_frame.pack(fill="x", pady=10)
        
        ctk.CTkLabel(rate_frame, text="Commission Rate:", 
                    font=ctk.CTkFont(weight="bold"),
                    width=150).pack(side="left", padx=10)
        
        self.commission_entry = ctk.CTkEntry(rate_frame, width=100)
        if barber_info:
            self.commission_entry.insert(0, str(barber_info['commission_rate']))
        else:
            self.commission_entry.insert(0, "70")
        self.commission_entry.pack(side="left", padx=10)
        
        ctk.CTkLabel(rate_frame, text="%").pack(side="left", padx=5)
        
        # Commission explanation
        info_frame = ctk.CTkFrame(frame, fg_color="#e9ecef", corner_radius=10)
        info_frame.pack(fill="x", pady=20)
        
        info_text = """
üí° Commission Information:
‚Ä¢ Barber receives this percentage of their service revenue
‚Ä¢ Shop keeps the remaining percentage
‚Ä¢ Example: $35 haircut with 70% commission = $24.50 for barber, $10.50 for shop
‚Ä¢ Commission is calculated weekly and paid every Friday
        """
        
        ctk.CTkLabel(info_frame, text=info_text,
                    font=ctk.CTkFont(size=11),
                    justify="left").pack(padx=10, pady=10)
        
        # Quick calculation tool
        calc_frame = ctk.CTkFrame(frame)
        calc_frame.pack(fill="x", pady=10)
        
        ctk.CTkLabel(calc_frame, text="Quick Calculator:", 
                    font=ctk.CTkFont(weight="bold")).pack(pady=5)
        
        calc_input_frame = ctk.CTkFrame(calc_frame, fg_color="transparent")
        calc_input_frame.pack(pady=5)
        
        ctk.CTkLabel(calc_input_frame, text="Service Price:").pack(side="left", padx=5)
        calc_price = ctk.CTkEntry(calc_input_frame, width=80)
        calc_price.insert(0, "35.00")
        calc_price.pack(side="left", padx=5)
        
        def calculate_commission():
            try:
                price = float(calc_price.get())
                commission_rate = float(self.commission_entry.get())
                barber_earn = price * (commission_rate / 100)
                shop_earn = price - barber_earn
                
                result_text = f"üí∞ Barber: ${barber_earn:.2f}\nüè™ Shop: ${shop_earn:.2f}"
                calc_result.configure(text=result_text)
            except:
                calc_result.configure(text="Invalid input")
        
        ctk.CTkButton(calc_input_frame, text="Calculate", 
                     command=calculate_commission,
                     width=80).pack(side="left", padx=10)
        
        calc_result = ctk.CTkLabel(frame, text="", 
                                  font=ctk.CTkFont(size=12, weight="bold"))
        calc_result.pack(pady=10)
        
        # Calculate immediately
        calculate_commission()
    
    def upload_barber_photo(self):
        """Upload barber photo"""
        filetypes = [
            ("Image files", "*.png *.jpg *.jpeg *.gif *.bmp"),
            ("All files", "*.*")
        ]
        
        filename = filedialog.askopenfilename(
            title="Select Barber Photo",
            filetypes=filetypes
        )
        
        if filename:
            self.current_photo_path = filename
            self.photo_preview_label.configure(text=os.path.basename(filename))
    
    def save_barber(self, barber_info, dialog):
        """Save barber changes"""
        # Validate required fields
        required_fields = ['name', 'specialization', 'hourly_rate']
        for field in required_fields:
            if field in self.barber_fields:
                value = self.barber_fields[field].get()
                if not value or value.strip() == '':
                    messagebox.showerror("Error", f"{field.title()} is required!")
                    return
        
        try:
            # Prepare barber data
            barber_data = {
                'id': barber_info['id'],
                'name': self.barber_fields['name'].get().strip(),
                'specialization': self.barber_fields['specialization'].get(),
                'hourly_rate': float(self.barber_fields['hourly_rate'].get()),
                'commission_rate': float(self.commission_entry.get()),
                'phone': self.barber_fields.get('phone', ctk.CTkEntry()).get().strip() 
                        if 'phone' in self.barber_fields else '',
                'email': self.barber_fields.get('email', ctk.CTkEntry()).get().strip() 
                       if 'email' in self.barber_fields else '',
                'address': self.barber_fields.get('address', ctk.CTkEntry()).get().strip() 
                          if 'address' in self.barber_fields else '',
                'notes': self.barber_fields.get('notes', ctk.CTkTextbox()).get("1.0", "end-1c").strip() 
                        if 'notes' in self.barber_fields else '',
                'is_active': self.active_var.get(),
                'photo_path': self.current_photo_path
            }
            
            # Save photo if new one uploaded
            if self.current_photo_path and self.current_photo_path != barber_info.get('photo_path', ''):
                new_photo_path = self.barber_mgr.save_barber_photo(
                    barber_info['id'], 
                    self.current_photo_path
                )
                if new_photo_path:
                    barber_data['photo_path'] = new_photo_path
            
            # Prepare schedule data
            schedule_data = []
            for day_key, fields in self.schedule_fields.items():
                if fields['working'].get():
                    schedule_data.append({
                        'day': day_key,
                        'start_time': fields['start'].get(),
                        'end_time': fields['end'].get(),
                        'is_working': True
                    })
            
            barber_data['schedule'] = schedule_data
            
            # Update in database
            if self.barber_mgr.update_barber(barber_data):
                messagebox.showinfo("Success", "Barber updated successfully!")
                dialog.destroy()
                # Refresh barbers view if we're in barbers section
                if hasattr(self, 'current_view') and self.current_view == 'barbers':
                    self.show_barbers()
            else:
                messagebox.showerror("Error", "Failed to update barber")
                
        except ValueError as e:
            messagebox.showerror("Error", f"Invalid number format: {e}")
        except Exception as e:
            messagebox.showerror("Error", f"Error saving barber: {e}")
    
    def create_new_barber(self, dialog):
        """Create new barber"""
        # Validate required fields
        required_fields = ['name', 'specialization', 'hourly_rate']
        for field in required_fields:
            if field in self.barber_fields:
                value = self.barber_fields[field].get()
                if not value or value.strip() == '':
                    messagebox.showerror("Error", f"{field.title()} is required!")
                    return
        
        try:
            # Prepare barber data
            barber_data = {
                'name': self.barber_fields['name'].get().strip(),
                'specialization': self.barber_fields['specialization'].get(),
                'hourly_rate': float(self.barber_fields['hourly_rate'].get()),
                'commission_rate': float(self.commission_entry.get()),
                'phone': self.barber_fields.get('phone', ctk.CTkEntry()).get().strip() 
                        if 'phone' in self.barber_fields else '',
                'email': self.barber_fields.get('email', ctk.CTkEntry()).get().strip() 
                       if 'email' in self.barber_fields else '',
                'address': self.barber_fields.get('address', ctk.CTkEntry()).get().strip() 
                          if 'address' in self.barber_fields else '',
                'notes': self.barber_fields.get('notes', ctk.CTkTextbox()).get("1.0", "end-1c").strip() 
                        if 'notes' in self.barber_fields else '',
                'is_active': self.active_var.get(),
                'photo_path': self.current_photo_path
            }
            
            # Prepare schedule data
            schedule_data = []
            for day_key, fields in self.schedule_fields.items():
                if fields['working'].get():
                    schedule_data.append({
                        'day': day_key,
                        'start_time': fields['start'].get(),
                        'end_time': fields['end'].get(),
                        'is_working': True
                    })
            
            barber_data['schedule'] = schedule_data
            
            # Create in database
            barber_id = self.barber_mgr.create_barber(barber_data)
            
            if barber_id:
                # Save photo if provided
                if self.current_photo_path:
                    new_photo_path = self.barber_mgr.save_barber_photo(
                        barber_id, 
                        self.current_photo_path
                    )
                    if new_photo_path:
                        # Update barber with photo path
                        conn = self.db.get_connection()
                        cursor = conn.cursor()
                        cursor.execute(
                            "UPDATE barbers SET photo_path = ? WHERE id = ?",
                            (new_photo_path, barber_id)
                        )
                        conn.commit()
                        conn.close()
                
                messagebox.showinfo("Success", f"Barber created successfully! ID: {barber_id}")
                dialog.destroy()
                # Refresh barbers view if we're in barbers section
                if hasattr(self, 'current_view') and self.current_view == 'barbers':
                    self.show_barbers()
            else:
                messagebox.showerror("Error", "Failed to create barber")
                
        except ValueError as e:
            messagebox.showerror("Error", f"Invalid number format: {e}")
        except Exception as e:
            messagebox.showerror("Error", f"Error creating barber: {e}")
    
    def add_barber_dialog(self):
        """Open add barber dialog (compatible with existing calls)"""
        self.open_barber_editor(None, "Add New Barber")
    
    def book_for_barber(self, barber_id, parent_dialog=None):
        """Book appointment for this barber"""
        if parent_dialog:
            parent_dialog.destroy()
        
        # Store selected barber ID
        self.selected_barber_id = barber_id
        
        # Show booking screen
        self.show_booking()
        
        # Here you would pre-select the barber in the booking form
        # This requires integration with the booking system
    
    def generate_barber_report(self, barber_id, parent_dialog=None):
        """Generate report for barber"""
        if parent_dialog:
            parent_dialog.destroy()
        
        # Generate and show barber report
        self.report_gen.generate_barber_performance_report(barber_id)
        messagebox.showinfo("Report", f"Report generated for barber {barber_id}")
    
    def center_window(self, window):
        """Center a window on screen"""
        window.update_idletasks()
        width = window.winfo_width()
        height = window.winfo_height()
        x = (window.winfo_screenwidth() // 2) - (width // 2)
        y = (window.winfo_screenheight() // 2) - (height // 2)
        window.geometry(f'{width}x{height}+{x}+{y}')
####################################

    # Database helper methods
    def get_all_clients(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT id, name, phone, email, membership_level, 
                visits_count, last_visit, join_date
            FROM clients 
            ORDER BY name
        ''')
        clients = cursor.fetchall()
        conn.close()
        return clients

    def get_membership_plans(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT * FROM membership_plans 
            ORDER BY price DESC
        ''')
        plans = cursor.fetchall()
        conn.close()
        return plans

    def get_vip_clients_stats(self):
        # This would query the database for real stats
        # Returning sample data for now
        return {
            'total_vip': 24,
            'avg_visits': 8.5,
            'monthly_revenue': 4520.75,
            'top_spender': 625.50
        }

    def get_vip_clients(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT name, phone, membership_level, visits_count, 
                (SELECT SUM(price) FROM bookings WHERE client_id = clients.id) as total_spent,
                last_visit
            FROM clients 
            WHERE membership_level IN ('VIP', 'Gold')
            ORDER BY total_spent DESC
        ''')
        vip_clients = cursor.fetchall()
        conn.close()
        return vip_clients

    def get_all_barbers(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT * FROM barbers 
            ORDER BY is_active DESC, name
        ''')
        barbers = cursor.fetchall()
        conn.close()
        return barbers

    # Event handlers
    def on_client_select(self, event):
        tree = event.widget
        selection = tree.selection()
        if selection:
            item = tree.item(selection[0])
            client_data = item['values']
            # You could display client details or enable edit buttons
            print(f"Selected client: {client_data[1]}")

    def add_membership_plan_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add Membership Plan")
        dialog.geometry("400x500")
        
        # Form fields
        fields = [
            ("Plan Name", "entry"),
            ("Visits for Free Visit", "number"),
            ("Discount Percentage", "number"),
            ("Price (AUD)", "number"),
            ("Duration (days)", "number")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields):
            ctk.CTkLabel(dialog, text=label).pack(pady=5)
            
            if field_type == "entry":
                entry = ctk.CTkEntry(dialog, width=300)
                entry.pack(pady=5)
                entries[label] = entry
            elif field_type == "number":
                entry = ctk.CTkEntry(dialog, width=300)
                entry.pack(pady=5)
                entries[label] = entry
    
        def save_plan():
            plan_data = {
                'name': entries["Plan Name"].get(),
                'visits_for_free': int(entries["Visits for Free Visit"].get()),
                'discount_percent': float(entries["Discount Percentage"].get()),
                'price': float(entries["Price (AUD)"].get()),
                'duration_days': int(entries["Duration (days)"].get())
            }
            
            self.membership_mgr.add_membership_plan(plan_data)
            dialog.destroy()
            messagebox.showinfo("Success", "Membership plan added!")
        
        ctk.CTkButton(dialog, text="Save Plan", command=save_plan).pack(pady=20)

    def assign_membership_plan(self, plan_id):
        # This would open a dialog to assign plan to selected client
        messagebox.showinfo("Assign Plan", f"Assigning plan {plan_id} to client")

    def view_barber_details(self, barber_id):
        # Open barber details dialog
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM barbers WHERE id = ?', (barber_id,))
        barber = cursor.fetchone()
        conn.close()
        
        if barber:
            dialog = ctk.CTkToplevel(self)
            dialog.title(f"Barber Details - {barber[1]}")
            dialog.geometry("500x400")
            
            # Display barber details
            details = [
                ("Name", barber[1]),
                ("Specialization", barber[2]),
                ("Hourly Rate", f"${barber[3]:.2f}"),
                ("Commission Rate", f"{barber[4]}%"),
                ("Status", "Active" if barber[6] else "Inactive"),
                ("Join Date", barber[7])
            ]
            
            for i, (label, value) in enumerate(details):
                frame = ctk.CTkFrame(dialog)
                frame.pack(fill="x", padx=20, pady=5)
                
                ctk.CTkLabel(frame, text=label, font=ctk.CTkFont(weight="bold"), 
                            width=150).pack(side="left", padx=10)
                ctk.CTkLabel(frame, text=str(value)).pack(side="left", padx=10)
            
            # Barber statistics
            stats_frame = ctk.CTkFrame(dialog)
            stats_frame.pack(fill="x", padx=20, pady=20)
            
            ctk.CTkLabel(stats_frame, text="This Week's Statistics", 
                        font=ctk.CTkFont(weight="bold", size=14)).pack(pady=10)
            
            # Sample stats - in real app, calculate from database
            stats = [
                ("Bookings", "18"),
                ("Revenue", "$630"),
                ("Hours Worked", "24"),
                ("Commission", "$441")
            ]
            
            for i, (label, value) in enumerate(stats):
                stat_card = ctk.CTkFrame(stats_frame, width=100, height=80)
                stat_card.grid(row=1, column=i, padx=10, pady=10)
                
                ctk.CTkLabel(stat_card, text=value, 
                            font=ctk.CTkFont(size=16, weight="bold")).pack(pady=(15, 5))
                ctk.CTkLabel(stat_card, text=label).pack()
            
            # Configure grid
            for i in range(4):
                stats_frame.grid_columnconfigure(i, weight=1)

    def edit_barber(self, barber_id):
        # Open edit barber dialog
        messagebox.showinfo("Edit", f"Editing barber {barber_id}")

   
    
    def show_booking(self):
        self.clear_main_frame()
        
        # Booking title
        title = ctk.CTkLabel(
            self.main_frame,
            text="New Booking",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.grid(row=0, column=0, columnspan=2, pady=(0, 20), sticky="w")
        
        # Create notebook for tabs
        notebook = ttk.Notebook(self.main_frame)
        notebook.grid(row=1, column=0, columnspan=2, sticky="nsew", pady=10)
        
        # Client Information Tab
        client_frame = ctk.CTkFrame(notebook)
        notebook.add(client_frame, text="Client Info")
        
        # Barber Selection Tab
        barber_frame = ctk.CTkFrame(notebook)
        notebook.add(barber_frame, text="Select Barber")
        
        # Services Tab
        service_frame = ctk.CTkFrame(notebook)
        notebook.add(service_frame, text="Services")
        
        # Time Selection Tab
        time_frame = ctk.CTkFrame(notebook)
        notebook.add(time_frame, text="Select Time")
        
        # Build client tab
        self.build_client_tab(client_frame)
        self.build_barber_tab(barber_frame)
        self.build_service_tab(service_frame)
        self.build_time_tab(time_frame)
        
        # Submit button
        submit_btn = ctk.CTkButton(
            self.main_frame,
            text="Confirm Booking",
            command=self.confirm_booking,
            height=40,
            font=ctk.CTkFont(size=14, weight="bold")
        )
        submit_btn.grid(row=2, column=0, columnspan=2, pady=20)
    
    def build_client_tab(self, parent):
        # Client search/select
        ctk.CTkLabel(parent, text="Client Name:").grid(row=0, column=0, padx=10, pady=10, sticky="w")
        self.client_var = ctk.StringVar()
        client_combo = ctk.CTkComboBox(parent, variable=self.client_var, values=self.get_client_list())
        client_combo.grid(row=0, column=1, padx=10, pady=10)
        
        # Or add new client
        ctk.CTkButton(parent, text="Add New Client", command=self.add_client_dialog).grid(row=0, column=2, padx=10, pady=10)
        
        # Membership display
        self.membership_label = ctk.CTkLabel(parent, text="Membership: None")
        self.membership_label.grid(row=1, column=0, columnspan=3, padx=10, pady=10, sticky="w")

        # Add membership info display
        def update_membership_info():
            client_name = self.client_var.get()
            if client_name:
                membership_info = self.membership_mgr.get_client_membership_info(client_name)
                if membership_info:
                    if membership_info['is_expired']:
                        status = f"‚ùå EXPIRED ({membership_info['membership_level']})"
                    else:
                        status = f"‚úÖ {membership_info['membership_level']}"
                    
                    info_text = (
                        f"{status}\n"
                        f"Visits: {membership_info['visits_count']} "
                    )
                    
                    if membership_info['visits_for_free']:
                        info_text += f"({membership_info['visits_remaining']} to free visit)\n"
                    
                    info_text += f"Discount: {membership_info['discount_percent']}%"
                    
                    self.membership_label.configure(text=info_text)
                else:
                    self.membership_label.configure(text="Membership: None")
        
        # Bind to client selection change
        self.client_var.trace_add('write', lambda *args: update_membership_info())
    
    def build_barber_tab(self, parent):
        # Barber selection with photos
        barbers = self.get_available_barbers()
        
        row, col = 0, 0
        self.selected_barber = tk.IntVar()
        
        for barber in barbers:
            barber_frame = ctk.CTkFrame(parent, width=180, height=200)
            barber_frame.grid(row=row, column=col, padx=10, pady=10)
            
            # Barber photo (placeholder)
            photo_label = ctk.CTkLabel(barber_frame, text="üë®‚Äçüíº", font=ctk.CTkFont(size=48))
            photo_label.pack(pady=10)
            
            # Barber name and info
            ctk.CTkLabel(barber_frame, text=barber[1], font=ctk.CTkFont(weight="bold")).pack()
            ctk.CTkLabel(barber_frame, text=barber[2]).pack()
            ctk.CTkLabel(barber_frame, text=f"${barber[3]}/hr").pack()
            
            # Select button
            ctk.CTkRadioButton(
                barber_frame,
                text="Select",
                variable=self.selected_barber,
                value=barber[0]
            ).pack(pady=5)
            
            col += 1
            if col > 2:
                col = 0
                row += 1
    
    def build_service_tab(self, parent):
        # Service selection with prices
        services = self.get_services()
        
        self.service_var = tk.StringVar()
        self.service_price_var = tk.DoubleVar(value=0.0)
        
        for i, service in enumerate(services):
            frame = ctk.CTkFrame(parent)
            frame.pack(fill="x", padx=10, pady=5)
            
            ctk.CTkRadioButton(
                frame,
                text=f"{service[1]} - ${service[3]:.2f}",
                variable=self.service_var,
                value=service[1],
                command=lambda s=service: self.update_price(s[3])
            ).pack(side="left", padx=10)
            
            ctk.CTkLabel(frame, text=service[5]).pack(side="right", padx=10)
        
        # Total price display
        price_frame = ctk.CTkFrame(parent)
        price_frame.pack(fill="x", padx=10, pady=20)
        
        ctk.CTkLabel(price_frame, text="Total Price:", font=ctk.CTkFont(weight="bold")).pack(side="left", padx=10)
        self.total_label = ctk.CTkLabel(price_frame, text="$0.00", font=ctk.CTkFont(size=18, weight="bold"))
        self.total_label.pack(side="right", padx=10)
    
    def build_time_tab(self, parent):
        # Date and time selection
        ctk.CTkLabel(parent, text="Select Date:").pack(anchor="w", padx=10, pady=5)
        
        self.date_var = ctk.StringVar(value=datetime.now().strftime("%Y-%m-%d"))
        date_entry = ctk.CTkEntry(parent, textvariable=self.date_var)
        date_entry.pack(fill="x", padx=10, pady=5)
        
        # Time slots
        ctk.CTkLabel(parent, text="Select Time:").pack(anchor="w", padx=10, pady=(20,5))
        
        time_frame = ctk.CTkFrame(parent)
        time_frame.pack(fill="x", padx=10, pady=5)
        
        self.time_var = tk.StringVar()
        time_slots = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"]
        
        row, col = 0, 0
        for time in time_slots:
            ctk.CTkRadioButton(
                time_frame,
                text=time,
                variable=self.time_var,
                value=time
            ).grid(row=row, column=col, padx=5, pady=5)
            col += 1
            if col > 2:
                col = 0
                row += 1
    

    ##########################################
    
    def show_dashboard(self):
        self.clear_main_frame()
        
        # Configure grid for better layout
        self.main_frame.grid_columnconfigure(0, weight=1)
        self.main_frame.grid_columnconfigure(1, weight=1)
        self.main_frame.grid_columnconfigure(2, weight=1)
        
        # Dashboard title with quick check
        title_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        title_frame.grid(row=0, column=0, columnspan=3, pady=(0, 20), sticky="ew")
        
        # Dashboard title
        ctk.CTkLabel(
            title_frame,
            text="Dashboard",
            font=ctk.CTkFont(size=24, weight="bold")
        ).pack(side="left")
        
        # Define phone_var and quick_check_frame at the class level or locally
        phone_var = ctk.StringVar()
        
        # Quick phone check widget for dashboard
        quick_check_frame = ctk.CTkFrame(title_frame, fg_color="transparent")
        quick_check_frame.pack(side="right", padx=10)
        
        phone_entry = ctk.CTkEntry(
            quick_check_frame,
            placeholder_text="Check by phone...",
            textvariable=phone_var,
            width=150,
            height=35
        )
        phone_entry.pack(side="left", padx=(0, 5))
        
        def quick_dashboard_check():
            phone = phone_var.get()
            if self.validate_phone_format(phone):
                client_info = self.get_client_by_phone(phone)
                if client_info:
                    client_id, name, membership_level, visits_count, last_visit = client_info
                    # Get detailed membership info
                    membership_info = self.membership_mgr.get_client_membership_info(name)
                    
                    # Create custom dialog
                    dialog = ctk.CTkToplevel(self)
                    dialog.title(f"Membership Status - {name}")
                    dialog.geometry("400x350")
                    dialog.transient(self)
                    dialog.grab_set()
                    
                    # Center dialog
                    dialog.update_idletasks()
                    width = dialog.winfo_width()
                    height = dialog.winfo_height()
                    x = (self.winfo_screenwidth() // 2) - (width // 2)
                    y = (self.winfo_screenheight() // 2) - (height // 2)
                    dialog.geometry(f'{width}x{height}+{x}+{y}')
                    
                    # Header
                    header = ctk.CTkFrame(dialog, fg_color="#3a7ebf", height=50)
                    header.pack(fill="x", pady=(0, 20))
                    ctk.CTkLabel(header, text="Membership Status", 
                            font=ctk.CTkFont(size=18, weight="bold"),
                            text_color="white").pack(pady=15)
                    
                    # Client info
                    info_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    info_frame.pack(fill="both", expand=True, padx=20, pady=10)
                    
                    info_rows = [
                        ("üë§ Client:", name),
                        ("üì± Phone:", phone),
                        ("üìÖ Last Visit:", last_visit or "Never"),
                        ("üìä Total Visits:", str(visits_count))
                    ]
                    
                    for label, value in info_rows:
                        row_frame = ctk.CTkFrame(info_frame, fg_color="transparent")
                        row_frame.pack(fill="x", pady=5)
                        ctk.CTkLabel(row_frame, text=label, font=ctk.CTkFont(weight="bold"), 
                                width=100).pack(side="left", padx=5)
                        ctk.CTkLabel(row_frame, text=value).pack(side="left", padx=5)
                    
                    # Membership status
                    status_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    status_frame.pack(fill="x", padx=20, pady=10)
                    
                    if membership_info:
                        if membership_info.get('is_expired', False):
                            status_color = "#dc3545"
                            status_text = f"‚ùå EXPIRED ({membership_level})"
                        else:
                            status_color = "#28a745"
                            status_text = f"‚úÖ ACTIVE ({membership_level})"
                        
                        ctk.CTkLabel(status_frame, text="Status:", 
                                font=ctk.CTkFont(weight="bold")).pack(side="left", padx=5)
                        ctk.CTkLabel(status_frame, text=status_text,
                                text_color=status_color).pack(side="left", padx=5)
                        
                        # Membership details
                        details_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                        details_frame.pack(fill="x", padx=20, pady=10)
                        
                        discount = membership_info.get('discount_percent', 0)
                        if discount:
                            ctk.CTkLabel(details_frame, text=f"üéØ Discount: {discount}%").pack(anchor="w")
                        
                        visits_for_free = membership_info.get('visits_for_free')
                        if visits_for_free:
                            remaining = membership_info.get('visits_remaining', 0)
                            if remaining == 1:
                                ctk.CTkLabel(details_frame, text="üéâ Next visit is FREE!", 
                                        text_color="#ff9900", font=ctk.CTkFont(weight="bold")).pack(anchor="w", pady=5)
                            elif remaining <= 3:
                                ctk.CTkLabel(details_frame, text=f"‚≠ê {remaining} visits until FREE", 
                                        text_color="#17a2b8").pack(anchor="w")
                    
                    # Action buttons
                    btn_frame = ctk.CTkFrame(dialog, fg_color="transparent")
                    btn_frame.pack(pady=20)
                    
                    ctk.CTkButton(btn_frame, text="Book Appointment", 
                                command=lambda: self.book_for_client(client_id, dialog),
                                width=120).pack(side="left", padx=5)
                    ctk.CTkButton(btn_frame, text="Close", 
                                command=dialog.destroy,
                                width=80).pack(side="left", padx=5)
                    
                    # Clear phone field
                    phone_var.set("")
                else:
                    # Client not found - offer to add
                    response = messagebox.askyesno(
                        "Client Not Found",
                        f"No client found with phone: {phone}\n\nWould you like to add as new client?"
                    )
                    if response:
                        self.add_client_from_quick_check(phone)
            else:
                messagebox.showerror("Invalid Phone", "Please enter a valid 10-digit Australian phone number")
        
        ctk.CTkButton(
            quick_check_frame,
            text="üîç Quick Check",
            width=120,
            height=35,
            command=quick_dashboard_check,
            fg_color="#17a2b8",
            hover_color="#138496"
        ).pack(side="left")
        
        # Today's summary
        today = datetime.now().strftime("%Y-%m-%d")
        today_stats = self.booking_mgr.get_daily_stats(today)
        
        # Stats cards
        stats_frame = ctk.CTkFrame(self.main_frame)
        stats_frame.grid(row=1, column=0, columnspan=3, pady=(0, 20), sticky="ew")
        
        stats = [
            ("Today's Bookings", f"{today_stats.get('total_bookings', 0)}", "#3a7ebf"),
            ("Today's Revenue", f"${today_stats.get('total_revenue', 0):.2f}", "#28a745"),
            ("Active Clients", f"{self.membership_mgr.get_active_clients_count()}", "#9c4dcc"),
            ("Available Barbers", f"{len(self.get_available_barbers())}", "#6c757d")
        ]
        
        for i, (label, value, color) in enumerate(stats):
            card = ctk.CTkFrame(stats_frame, width=200, height=100, corner_radius=10)
            card.grid(row=0, column=i, padx=10, pady=10, sticky="nsew")
            
            # Colored header
            header = ctk.CTkFrame(card, fg_color=color, height=30, corner_radius=10)
            header.pack(fill="x", pady=(0, 10))
            ctk.CTkLabel(header, text=label, text_color="white",
                        font=ctk.CTkFont(size=11)).pack(pady=5)
            
            ctk.CTkLabel(card, text=value, font=ctk.CTkFont(size=28, weight="bold")).pack(pady=(5, 0))
        
        # Quick actions
        actions_frame = ctk.CTkFrame(self.main_frame)
        actions_frame.grid(row=2, column=0, columnspan=2, pady=20, sticky="nsew")
        
        ctk.CTkLabel(actions_frame, text="‚ö° Quick Actions", 
                    font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=10)
        
        action_buttons = [
            ("üìÖ New Booking", self.show_booking, "#3a7ebf"),
            ("üë§ Add Client", self.add_client_dialog, "#28a745"),
            ("üíà Add Barber", self.add_barber_dialog, "#6c757d"),
            ("üí∞ Process Payment", self.process_payment_dialog, "#ff9900"),
            ("üì¶ Restock", self.restock_dialog, "#fd7e14"),
            ("üìä Daily Report", self.generate_daily_report, "#9c4dcc")
        ]
        
        for text, command, color in action_buttons:
            btn = ctk.CTkButton(actions_frame, text=text, command=command, 
                            fg_color=color, hover_color=self.darken_color(color),
                            height=40, corner_radius=8)
            btn.pack(fill="x", padx=10, pady=5, anchor="w")
        
        # Recent bookings
        recent_frame = ctk.CTkFrame(self.main_frame)
        recent_frame.grid(row=3, column=0, columnspan=3, pady=20, sticky="nsew")
        
        ctk.CTkLabel(recent_frame, text="üìã Recent Bookings", 
                    font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=10)
        
        # Create treeview for recent bookings
        columns = ("ID", "Client", "Barber", "Service", "Time", "Status")
        tree = ttk.Treeview(recent_frame, columns=columns, show="headings", height=6)
        
        column_widths = {
            "ID": 50, "Client": 120, "Barber": 100, 
            "Service": 120, "Time": 80, "Status": 80
        }
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=column_widths.get(col, 100))
        
        # Add scrollbar
        scrollbar = ttk.Scrollbar(recent_frame, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side="left", fill="both", expand=True, padx=(10, 0), pady=(0, 10))
        scrollbar.pack(side="right", fill="y", pady=(0, 10))
        
        # Get recent bookings using updated booking manager
        recent_bookings_data = self.booking_mgr.get_recent_bookings(limit=10)
        
        # Add data to treeview
        for booking in recent_bookings_data:
            tree.insert("", "end", values=(
                booking.get('id', ''),
                booking.get('client_name', ''),
                booking.get('barber_name', ''),
                booking.get('service', ''),
                booking.get('time', ''),
                booking.get('status', '')
            ))
        
        # Color code status
        tree.tag_configure('Confirmed', background='#d4edda')
        tree.tag_configure('Pending', background='#fff3cd')
        tree.tag_configure('Completed', background='#d1ecf1')
        tree.tag_configure('Cancelled', background='#f8d7da')
        
        # Configure grid weights
        stats_frame.grid_columnconfigure(0, weight=1)
        stats_frame.grid_columnconfigure(1, weight=1)
        stats_frame.grid_columnconfigure(2, weight=1)
        stats_frame.grid_columnconfigure(3, weight=1)
        
        actions_frame.grid_columnconfigure(0, weight=1)
        recent_frame.grid_columnconfigure(0, weight=1)


    
    def show_store(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Store Management",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Create notebook for store sections
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Inventory tab
        inventory_frame = ctk.CTkFrame(notebook)
        notebook.add(inventory_frame, text="Inventory")
        self.build_inventory_tab(inventory_frame)
        
        # Sales tab
        sales_frame = ctk.CTkFrame(notebook)
        notebook.add(sales_frame, text="Sales")
        self.build_sales_tab(sales_frame)
        
        # Products display tab
        display_frame = ctk.CTkFrame(notebook)
        notebook.add(display_frame, text="Product Display")
        self.build_display_tab(display_frame)
    
    def build_inventory_tab(self, parent):
        # Inventory management interface
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkButton(toolbar, text="Add Product", command=self.add_product_dialog).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Restock", command=self.restock_dialog).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Export", command=self.export_inventory).pack(side="left", padx=5)
        
        # Inventory list
        columns = ("ID", "Product", "Category", "Stock", "Buy Price", "Sell Price", "Total Value")
        tree = ttk.Treeview(parent, columns=columns, show="headings", height=15)
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=100)
        
        # Add scrollbar
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side="left", fill="both", expand=True, padx=(10,0), pady=(0,10))
        scrollbar.pack(side="right", fill="y", pady=(0,10))
        
        # Load inventory data
        inventory = self.inventory_mgr.get_inventory()
        for item in inventory:
            tree.insert("", "end", values=item)
    
    def build_display_tab(self, parent):
        # Product display for shop screen
        display_frame = ctk.CTkFrame(parent, fg_color="#2b2b2b")
        display_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        ctk.CTkLabel(
            display_frame,
            text="PRODUCTS SHOWCASE",
            font=ctk.CTkFont(size=28, weight="bold", family="Arial Black"),
            text_color="#ff9900"
        ).pack(pady=(20, 30))
        
        # Sample products display
        products = [
            ("Professional Hair Clipper", "$89.99", "Best for barbers"),
            ("Barber Cape", "$24.99", "Waterproof design"),
            ("Hair Styling Gel", "$15.99", "Strong hold"),
            ("Shaving Cream", "$12.99", "Sensitive skin"),
            ("Hair Tonic", "$18.99", "Natural ingredients"),
            ("Scissors Set", "$65.99", "Professional grade")
        ]
        
        row, col = 0, 0
        for name, price, desc in products:
            product_card = ctk.CTkFrame(
                display_frame,
                width=180,
                height=220,
                border_width=2,
                border_color="#ff9900",
                corner_radius=15
            )
            product_card.grid(row=row, column=col, padx=20, pady=20)
            
            ctk.CTkLabel(product_card, text="üõçÔ∏è", font=ctk.CTkFont(size=40)).pack(pady=10)
            ctk.CTkLabel(product_card, text=name, font=ctk.CTkFont(weight="bold")).pack()
            ctk.CTkLabel(product_card, text=price, font=ctk.CTkFont(size=16, weight="bold"), text_color="#4CAF50").pack()
            ctk.CTkLabel(product_card, text=desc, font=ctk.CTkFont(size=10)).pack(pady=5)
            
            col += 1
            if col > 2:
                col = 0
                row += 1
        
        # Make grid responsive
        for i in range(3):
            display_frame.grid_columnconfigure(i, weight=1)
        for i in range(2):
            display_frame.grid_rowconfigure(i, weight=1)
    
    def show_payments(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Payments & Payroll",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Barber payments tab
        payment_frame = ctk.CTkFrame(notebook)
        notebook.add(payment_frame, text="Barber Payments")
        
        # Expenses tab
        expense_frame = ctk.CTkFrame(notebook)
        notebook.add(expense_frame, text="Expenses")
        
        self.build_payment_tab(payment_frame)
        self.build_expense_tab(expense_frame)
    
    def build_payment_tab(self, parent):
        # Payroll management
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkButton(toolbar, text="Calculate Payroll", command=self.calculate_payroll).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Export PDF", command=self.export_payroll_pdf).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Process Payment", command=self.process_payment).pack(side="left", padx=5)
        
        # Commission rate setting
        settings_frame = ctk.CTkFrame(parent)
        settings_frame.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkLabel(settings_frame, text="Shop Commission Rate:").pack(side="left", padx=10)
        self.commission_var = ctk.StringVar(value=str(self.config.get('shop_commission')))
        commission_entry = ctk.CTkEntry(settings_frame, textvariable=self.commission_var, width=80)
        commission_entry.pack(side="left", padx=5)
        ctk.CTkLabel(settings_frame, text="%").pack(side="left", padx=5)
        ctk.CTkButton(settings_frame, text="Update", command=self.update_commission).pack(side="left", padx=10)
    
    def build_expense_tab(self, parent):
        # Expense management
        toolbar = ctk.CTkFrame(parent)
        toolbar.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkButton(toolbar, text="Add Expense", command=self.add_expense_dialog).pack(side="left", padx=5)
        ctk.CTkButton(toolbar, text="Monthly Report", command=self.generate_expense_report).pack(side="left", padx=5)
        
        # Expense categories
        categories = ["Rent", "Utilities", "Supplies", "Marketing", "Equipment", "Insurance", "Other"]
        
        row, col = 0, 0
        for category in categories:
            frame = ctk.CTkFrame(parent, width=150, height=100)
            frame.grid(row=row, column=col, padx=10, pady=10)
            
            # Get total for category
            total = self.get_expense_total(category)
            
            ctk.CTkLabel(frame, text=category, font=ctk.CTkFont(weight="bold")).pack(pady=10)
            ctk.CTkLabel(frame, text=f"${total:.2f}", font=ctk.CTkFont(size=16)).pack()
            
            col += 1
            if col > 2:
                col = 0
                row += 1
    
    def show_reports(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Reports & Analytics",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Report selection
        report_frame = ctk.CTkFrame(self.main_frame)
        report_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        reports = [
            ("Daily Revenue Report", self.generate_daily_report),
            ("Monthly Financial Report", self.generate_monthly_report),
            ("Barber Performance", self.generate_barber_report),
            ("Client Membership Report", self.generate_membership_report),
            ("Inventory Report", self.generate_inventory_report),
            ("Export All Data", self.export_all_data)
        ]
        
        row, col = 0, 0
        for report_name, command in reports:
            btn = ctk.CTkButton(
                report_frame,
                text=report_name,
                command=command,
                height=60,
                font=ctk.CTkFont(size=14),
                corner_radius=10
            )
            btn.grid(row=row, column=col, padx=15, pady=15, sticky="nsew")
            
            col += 1
            if col > 1:
                col = 0
                row += 1
        
        # Configure grid weights
        for i in range(2):
            report_frame.grid_columnconfigure(i, weight=1)
        for i in range(3):
            report_frame.grid_rowconfigure(i, weight=1)
    
    def show_settings(self):
        self.clear_main_frame()
        
        title = ctk.CTkLabel(
            self.main_frame,
            text="Settings",
            font=ctk.CTkFont(size=24, weight="bold")
        )
        title.pack(anchor="w", padx=20, pady=10)
        
        # Settings notebook
        notebook = ttk.Notebook(self.main_frame)
        notebook.pack(fill="both", expand=True, padx=10, pady=10)
        
        # General settings
        general_frame = ctk.CTkFrame(notebook)
        notebook.add(general_frame, text="General")
        
        # Business settings
        business_frame = ctk.CTkFrame(notebook)
        notebook.add(business_frame, text="Business")
        
        # UI settings
        ui_frame = ctk.CTkFrame(notebook)
        notebook.add(ui_frame, text="Appearance")
        
        self.build_general_settings(general_frame)
        self.build_business_settings(business_frame)
        self.build_ui_settings(ui_frame)
    
    def build_general_settings(self, parent):
        settings = [
            ("Shop Name", "shop_name", "text"),
            ("Currency", "currency", "text"),
            ("Tax Rate (%)", "tax_rate", "number"),
            ("Business Phone", "invoice.phone", "text"),
            ("Business Email", "invoice.email", "text"),
            ("Business Address", "invoice.company_address", "text")
        ]
        
        for i, (label, key, input_type) in enumerate(settings):
            ctk.CTkLabel(parent, text=label).grid(row=i, column=0, padx=20, pady=10, sticky="w")
            
            current_value = self.config.get(key, "")
            if input_type == "text":
                entry = ctk.CTkEntry(parent, width=300)
                entry.insert(0, str(current_value))
                entry.grid(row=i, column=1, padx=20, pady=10)
                entry.config_key = key
            elif input_type == "number":
                entry = ctk.CTkEntry(parent, width=300)
                entry.insert(0, str(current_value))
                entry.grid(row=i, column=1, padx=20, pady=10)
                entry.config_key = key
        
        save_btn = ctk.CTkButton(
            parent,
            text="Save Settings",
            command=self.save_settings,
            width=150
        )
        save_btn.grid(row=len(settings), column=0, columnspan=2, pady=20)
    
    def save_settings(self):
        # This would save all settings from the form
        messagebox.showinfo("Success", "Settings saved successfully!")
        self.config.save_config()
        self.title(f"{self.config.get('shop_name')} - Management System")
    
    # Helper methods
    def clear_main_frame(self):
        for widget in self.main_frame.winfo_children():
            widget.destroy()
    
    def get_client_list(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM clients ORDER BY name")
        clients = [row[0] for row in cursor.fetchall()]
        conn.close()
        return clients
    
    def get_available_barbers(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT id, name, specialization, hourly_rate, commission_rate FROM barbers WHERE is_active = 1")
        barbers = cursor.fetchall()
        conn.close()
        return barbers
    
    def get_services(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM services ORDER BY category, price")
        services = cursor.fetchall()
        conn.close()
        return services
    
    def load_sample_data(self):
        # Load sample barbers if none exist
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM barbers")
        if cursor.fetchone()[0] == 0:
            sample_barbers = [
                ("Tony", "Men's Haircut", "", 35.0, 70.0),
                ("Sophie", "Women's Styling", "", 45.0, 65.0),
                ("Mike", "Beard Specialist", "", 30.0, 75.0),
                ("Lisa", "Color Expert", "", 50.0, 60.0)
            ]
            cursor.executemany(
                "INSERT INTO barbers (name, specialization, photo_path, hourly_rate, commission_rate) VALUES (?, ?, ?, ?, ?)",
                sample_barbers
            )
            conn.commit()
        conn.close()
    
    def update_price(self, price):
        self.service_price_var.set(price)
        self.total_label.configure(text=f"${price:.2f}")
    
    def confirm_booking(self):
        # Validate all fields
        if not all([self.client_var.get(), self.selected_barber.get(), self.service_var.get(), self.time_var.get()]):
            messagebox.showerror("Error", "Please fill all fields")
            return
        
        # Calculate final price with membership discount
        final_price = self.service_price_var.get()
        
        # Apply membership discount if applicable
        client_name = self.client_var.get()
        discount = self.membership_mgr.get_client_discount(client_name)
        if discount > 0:
            final_price *= (1 - discount/100)
        
        # Create booking
        booking_data = {
            'client_name': client_name,
            'barber_id': self.selected_barber.get(),
            'service': self.service_var.get(),
            'price': final_price,
            'date': self.date_var.get(),
            'time': self.time_var.get()
        }
        
        success = self.booking_mgr.create_booking(booking_data)
        if success:
            messagebox.showinfo("Success", "Booking confirmed!")
            # Update client visits
            self.membership_mgr.update_client_visits(client_name)
            self.show_dashboard()
        else:
            messagebox.showerror("Error", "Failed to create booking")
    
    def add_client_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add New Client")
        dialog.geometry("400x400")
        
        # Client form
        fields = [
            ("Name", "entry"),
            ("Phone", "entry"),
            ("Email", "entry"),
            ("Membership Plan", "combo")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields):
            ctk.CTkLabel(dialog, text=label).pack(pady=5)
            
            if field_type == "entry":
                entry = ctk.CTkEntry(dialog, width=300)
                entry.pack(pady=5)
                entries[label] = entry
            elif field_type == "combo":
                combo = ctk.CTkComboBox(dialog, values=["Regular", "VIP", "Gold", "Student"])
                combo.pack(pady=5)
                entries[label] = combo
        
        def save_client():
            # Save client logic
            dialog.destroy()
            messagebox.showinfo("Success", "Client added successfully!")
        
        ctk.CTkButton(dialog, text="Save", command=save_client).pack(pady=20)
    
    def add_barber_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add New Barber")
        dialog.geometry("400x500")
        
        # Barber form
        fields = [
            ("Name", "entry"),
            ("Specialization", "combo"),
            ("Hourly Rate (AUD)", "entry"),
            ("Commission Rate (%)", "entry"),
            ("Photo", "file")
        ]
        
        for i, (label, field_type) in enumerate(fields):
            ctk.CTkLabel(dialog, text=label).pack(pady=5)
            
            if field_type == "entry":
                ctk.CTkEntry(dialog, width=300).pack(pady=5)
            elif field_type == "combo":
                ctk.CTkComboBox(dialog, values=["Haircut", "Beard", "Styling", "Coloring"]).pack(pady=5)
            elif field_type == "file":
                ctk.CTkButton(dialog, text="Select Photo", width=300).pack(pady=5)
        
        ctk.CTkButton(dialog, text="Save Barber").pack(pady=20)
    
    def add_product_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add Product to Inventory")
        dialog.geometry("400x500")
        
        # Product form
        fields = [
            ("Product Name", "entry"),
            ("Category", "combo"),
            ("Brand", "entry"),
            ("Quantity", "entry"),
            ("Buy Price", "entry"),
            ("Sell Price", "entry"),
            ("Supplier", "entry")
        ]
        
        for i, (label, field_type) in enumerate(fields):
            ctk.CTkLabel(dialog, text=label).pack(pady=5)
            
            if field_type == "entry":
                ctk.CTkEntry(dialog, width=300).pack(pady=5)
            elif field_type == "combo":
                ctk.CTkComboBox(dialog, values=["Tools", "Products", "Accessories", "Consumables"]).pack(pady=5)
        
        ctk.CTkButton(dialog, text="Add Product").pack(pady=20)
    
    def add_expense_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Add Expense")
        dialog.geometry("400x300")
        
        fields = [
            ("Category", "combo"),
            ("Amount (AUD)", "entry"),
            ("Description", "entry"),
            ("Payment Method", "combo")
        ]
        
        for i, (label, field_type) in enumerate(fields):
            ctk.CTkLabel(dialog, text=label).pack(pady=5)
            
            if field_type == "entry":
                ctk.CTkEntry(dialog, width=300).pack(pady=5)
            elif field_type == "combo":
                if label == "Category":
                    values = ["Rent", "Utilities", "Supplies", "Marketing", "Equipment", "Insurance", "Other"]
                else:
                    values = ["Cash", "Card", "Bank Transfer", "Online"]
                ctk.CTkComboBox(dialog, values=values).pack(pady=5)
        
        ctk.CTkButton(dialog, text="Record Expense").pack(pady=20)
    
    def calculate_payroll(self):
        # Calculate weekly payroll for all barbers
        period_start = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
        period_end = datetime.now().strftime("%Y-%m-%d")
        
        barbers = self.get_available_barbers()
        for barber in barbers:
            barber_id = barber[0]
            earnings = self.payroll_mgr.calculate_earnings(barber_id, period_start, period_end)
            
            # Apply commission
            commission_rate = barber[4]
            shop_commission = self.config.get('shop_commission', 30.0)
            barber_share = earnings * (commission_rate / 100)
            shop_share = earnings * (shop_commission / 100)
            net_pay = barber_share - shop_share
            
            # Record payroll
            self.payroll_mgr.record_payroll(
                barber_id, period_start, period_end,
                earnings, barber_share, shop_share, net_pay
            )
        
        messagebox.showinfo("Payroll", "Payroll calculated successfully!")
    
    def export_payroll_pdf(self):
        # Generate PDF payroll report
        filename = f"payroll_{datetime.now().strftime('%Y%m%d')}.pdf"
        self.report_gen.generate_payroll_pdf(filename)
        messagebox.showinfo("Export", f"Payroll exported to {filename}")
    
    def update_commission(self):
        try:
            commission = float(self.commission_var.get())
            self.config.set('shop_commission', commission)
            messagebox.showinfo("Success", f"Commission rate updated to {commission}%")
        except ValueError:
            messagebox.showerror("Error", "Please enter a valid number")
    
    def generate_daily_report(self):
        self.report_gen.generate_daily_report()
        messagebox.showinfo("Report", "Daily report generated!")
    
    def generate_monthly_report(self):
        self.report_gen.generate_monthly_report()
        messagebox.showinfo("Report", "Monthly report generated!")
    
    def get_expense_total(self, category):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT SUM(amount) FROM expenses WHERE category = ?", (category,))
        total = cursor.fetchone()[0] or 0
        conn.close()
        return total
    
    def restock_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Restock Product")
        dialog.geometry("300x200")
        
        ctk.CTkLabel(dialog, text="Select Product:").pack(pady=10)
        product_combo = ctk.CTkComboBox(dialog, values=self.get_product_list())
        product_combo.pack(pady=5)
        
        ctk.CTkLabel(dialog, text="Quantity:").pack(pady=10)
        quantity_entry = ctk.CTkEntry(dialog)
        quantity_entry.pack(pady=5)
        
        def process_restock():
            # Restock logic
            dialog.destroy()
            messagebox.showinfo("Success", "Product restocked!")
        
        ctk.CTkButton(dialog, text="Restock", command=process_restock).pack(pady=20)
    
    def get_product_list(self):
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT product_name FROM inventory")
        products = [row[0] for row in cursor.fetchall()]
        conn.close()
        return products
    
    def export_inventory(self):
        filename = f"inventory_{datetime.now().strftime('%Y%m%d')}.csv"
        self.report_gen.export_inventory_csv(filename)
        messagebox.showinfo("Export", f"Inventory exported to {filename}")
    
    def process_payment_dialog(self):
        dialog = ctk.CTkToplevel(self)
        dialog.title("Process Payment")
        dialog.geometry("400x300")
        
        # Payment form
        ctk.CTkLabel(dialog, text="Booking ID:").pack(pady=10)
        booking_entry = ctk.CTkEntry(dialog)
        booking_entry.pack(pady=5)
        
        ctk.CTkLabel(dialog, text="Payment Method:").pack(pady=10)
        payment_combo = ctk.CTkComboBox(dialog, values=["Cash", "Card", "Online", "Membership"])
        payment_combo.pack(pady=5)
        
        def process_payment():
            # Payment processing logic
            dialog.destroy()
            messagebox.showinfo("Success", "Payment processed!")
        
        ctk.CTkButton(dialog, text="Process Payment", command=process_payment).pack(pady=20)
    
    def process_payment(self):
        # Process selected barber payments
        messagebox.showinfo("Payment", "Payments processed successfully!")
    
    def generate_expense_report(self):
        self.report_gen.generate_expense_report()
        messagebox.showinfo("Report", "Expense report generated!")
    
    def generate_barber_report(self):
        self.report_gen.generate_barber_performance_report()
        messagebox.showinfo("Report", "Barber performance report generated!")
    
    def generate_membership_report(self):
        self.report_gen.generate_membership_report()
        messagebox.showinfo("Report", "Membership report generated!")
    
    def generate_inventory_report(self):
        self.report_gen.generate_inventory_report()
        messagebox.showinfo("Report", "Inventory report generated!")
    
    def export_all_data(self):
        self.report_gen.export_all_data()
        messagebox.showinfo("Export", "All data exported successfully!")
    
    def build_business_settings(self, parent):
        ctk.CTkLabel(parent, text="Business Hours:").pack(anchor="w", padx=20, pady=(20,5))
        
        days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
        business_hours = self.config.get('business_hours')
        
        for day in days:
            frame = ctk.CTkFrame(parent, height=40)
            frame.pack(fill="x", padx=20, pady=2)
            
            ctk.CTkLabel(frame, text=day, width=100).pack(side="left", padx=10)
            entry = ctk.CTkEntry(frame, width=200)
            entry.insert(0, business_hours.get(day.lower(), "9:00-18:00"))
            entry.pack(side="left", padx=10)
    
    def build_ui_settings(self, parent):
        ctk.CTkLabel(parent, text="Theme:").pack(anchor="w", padx=20, pady=10)
        
        theme_var = tk.StringVar(value=self.config.get('ui.theme'))
        theme_combo = ctk.CTkComboBox(
            parent,
            values=["dark", "light", "system"],
            variable=theme_var,
            command=self.change_theme
        )
        theme_combo.pack(anchor="w", padx=20, pady=5)
        
        ctk.CTkLabel(parent, text="Accent Color:").pack(anchor="w", padx=20, pady=10)
        
        color_frame = ctk.CTkFrame(parent)
        color_frame.pack(anchor="w", padx=20, pady=5)
        
        colors = ["#3a7ebf", "#1f6aa5", "#2fa572", "#9c4dcc", "#e69500", "#d44040"]
        for color in colors:
            btn = ctk.CTkButton(
                color_frame,
                text="",
                width=30,
                height=30,
                fg_color=color,
                hover_color=color,
                command=lambda c=color: self.change_accent_color(c)
            )
            btn.pack(side="left", padx=2)
    
    def change_theme(self, choice):
        ctk.set_appearance_mode(choice)
        self.config.set('ui.theme', choice)
    
    def change_accent_color(self, color):
        ctk.set_default_color_theme(color)
        self.config.set('ui.accent_color', color)
        messagebox.showinfo("Restart Required", "Please restart the application for color changes to take full effect.")


# Add to modules/gui_main.py

class WisePadConfigDialog(ctk.CTkToplevel):
    """Configuration dialog for WisePad 3"""
    
    def __init__(self, parent, wisepad_manager):
        super().__init__(parent)
        self.wisepad = wisepad_manager
        self.parent = parent
        
        self.title("WisePad 3 Configuration")
        self.geometry("500x600")
        self.transient(parent)
        self.grab_set()
        
        # Center dialog
        self.center_window()
        
        self.setup_ui()
        self.load_current_config()
    
    def center_window(self):
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f'{width}x{height}+{x}+{y}')
    
    def setup_ui(self):
        # Main frame
        main_frame = ctk.CTkFrame(self)
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        # Title
        ctk.CTkLabel(
            main_frame,
            text="WisePad 3 Configuration",
            font=ctk.CTkFont(size=20, weight="bold")
        ).pack(pady=(0, 20))
        
        # Connection status
        self.status_frame = ctk.CTkFrame(main_frame, height=60)
        self.status_frame.pack(fill="x", pady=(0, 20))
        
        self.status_label = ctk.CTkLabel(
            self.status_frame,
            text="Status: Not Connected",
            font=ctk.CTkFont(size=14)
        )
        self.status_label.pack(pady=10)
        
        # Connection buttons
        conn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        conn_frame.pack(fill="x", pady=(0, 20))
        
        ctk.CTkButton(
            conn_frame,
            text="üîç Scan for Devices",
            command=self.scan_devices,
            width=150
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            conn_frame,
            text="üì° Test Connection",
            command=self.test_connection,
            width=150
        ).pack(side="left", padx=5)
        
        # Configuration form
        form_frame = ctk.CTkFrame(main_frame)
        form_frame.pack(fill="both", expand=True, pady=(0, 20))
        
        # Merchant ID
        ctk.CTkLabel(form_frame, text="Merchant ID:").grid(row=0, column=0, padx=10, pady=10, sticky="w")
        self.merchant_entry = ctk.CTkEntry(form_frame, width=250)
        self.merchant_entry.grid(row=0, column=1, padx=10, pady=10)
        
        # Terminal ID
        ctk.CTkLabel(form_frame, text="Terminal ID:").grid(row=1, column=0, padx=10, pady=10, sticky="w")
        self.terminal_entry = ctk.CTkEntry(form_frame, width=250)
        self.terminal_entry.grid(row=1, column=1, padx=10, pady=10)
        
        # API Key (password field)
        ctk.CTkLabel(form_frame, text="API Key:").grid(row=2, column=0, padx=10, pady=10, sticky="w")
        self.api_entry = ctk.CTkEntry(form_frame, width=250, show="‚Ä¢")
        self.api_entry.grid(row=2, column=1, padx=10, pady=10)
        
        # Show/Hide API key button
        self.show_api_var = ctk.BooleanVar(value=False)
        ctk.CTkCheckBox(
            form_frame,
            text="Show API Key",
            variable=self.show_api_var,
            command=self.toggle_api_visibility
        ).grid(row=3, column=1, padx=10, pady=5, sticky="w")
        
        # Auto-connect
        ctk.CTkLabel(form_frame, text="Auto-connect:").grid(row=4, column=0, padx=10, pady=10, sticky="w")
        self.auto_connect_var = ctk.BooleanVar(value=True)
        ctk.CTkCheckBox(
            form_frame,
            text="Auto-connect on startup",
            variable=self.auto_connect_var
        ).grid(row=4, column=1, padx=10, pady=10, sticky="w")
        
        # Device list
        ctk.CTkLabel(form_frame, text="Available Devices:").grid(row=5, column=0, padx=10, pady=10, sticky="w")
        self.device_combo = ctk.CTkComboBox(form_frame, values=[], width=250)
        self.device_combo.grid(row=5, column=1, padx=10, pady=10)
        
        # Connection type
        ctk.CTkLabel(form_frame, text="Connection Type:").grid(row=6, column=0, padx=10, pady=10, sticky="w")
        self.connection_type = ctk.StringVar(value="bluetooth")
        ctk.CTkRadioButton(
            form_frame,
            text="Bluetooth",
            variable=self.connection_type,
            value="bluetooth"
        ).grid(row=6, column=1, padx=10, pady=5, sticky="w")
        ctk.CTkRadioButton(
            form_frame,
            text="USB/Serial",
            variable=self.connection_type,
            value="serial"
        ).grid(row=7, column=1, padx=10, pady=5, sticky="w")
        
        # Buttons
        button_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        button_frame.pack(pady=(0, 10))
        
        ctk.CTkButton(
            button_frame,
            text="üíæ Save & Connect",
            command=self.save_and_connect,
            width=120,
            fg_color="#28a745"
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            button_frame,
            text="üßπ Clear Settings",
            command=self.clear_settings,
            width=120,
            fg_color="#6c757d"
        ).pack(side="left", padx=5)
        
        ctk.CTkButton(
            button_frame,
            text="‚ùå Cancel",
            command=self.destroy,
            width=120,
            fg_color="#dc3545"
        ).pack(side="left", padx=5)
        
        # Log area
        ctk.CTkLabel(main_frame, text="Connection Log:").pack(anchor="w", pady=(10, 5))
        
        self.log_text = ctk.CTkTextbox(main_frame, height=100)
        self.log_text.pack(fill="x", pady=(0, 10))
    
    def load_current_config(self):
        """Load current configuration"""
        self.merchant_entry.insert(0, self.wisepad.merchant_id)
        self.terminal_entry.insert(0, self.wisepad.terminal_id)
        if self.wisepad.api_key:
            self.api_entry.insert(0, self.wisepad.api_key)
        
        # Update status
        self.update_status()
    
    def update_status(self):
        """Update connection status display"""
        if self.wisepad.is_connected:
            self.status_label.configure(
                text=f"‚úÖ Connected to {self.wisepad.device.get('name', 'WisePad')}",
                text_color="#28a745"
            )
        else:
            self.status_label.configure(
                text="‚ùå Not Connected",
                text_color="#dc3545"
            )
    
    def scan_devices(self):
        """Scan for WisePad devices"""
        self.log_message("üîç Scanning for WisePad devices...")
        
        devices = self.wisepad.discover_devices()
        
        if devices:
            device_names = []
            for device in devices:
                name = f"{device['name']} ({device['address']})"
                device_names.append(name)
            
            self.device_combo.configure(values=device_names)
            if device_names:
                self.device_combo.set(device_names[0])
            
            self.log_message(f"‚úÖ Found {len(devices)} device(s)")
        else:
            self.log_message("‚ùå No WisePad devices found")
    
    def test_connection(self):
        """Test connection to WisePad"""
        if not self.wisepad.is_connected:
            self.log_message("‚ö†Ô∏è Not connected to any device")
            return
        
        self.log_message("üîå Testing connection...")
        
        if self.wisepad.test_connection():
            self.log_message("‚úÖ Connection test successful")
            self.update_status()
        else:
            self.log_message("‚ùå Connection test failed")
    
    def toggle_api_visibility(self):
        """Toggle API key visibility"""
        if self.show_api_var.get():
            self.api_entry.configure(show="")
        else:
            self.api_entry.configure(show="‚Ä¢")
    
    def save_and_connect(self):
        """Save configuration and connect to device"""
        # Get values
        merchant_id = self.merchant_entry.get().strip()
        terminal_id = self.terminal_entry.get().strip()
        api_key = self.api_entry.get().strip()
        
        if not merchant_id or not terminal_id:
            self.log_message("‚ùå Merchant ID and Terminal ID are required")
            return
        
        # Update WisePad configuration
        self.wisepad.merchant_id = merchant_id
        self.wisepad.terminal_id = terminal_id
        self.wisepad.api_key = api_key if api_key else None
        
        # Save to file
        self.wisepad.save_config()
        
        # Connect to selected device
        selected_device = self.device_combo.get()
        if selected_device and selected_device != "":
            self.connect_to_device(selected_device)
        
        self.log_message("‚úÖ Configuration saved")
        self.update_status()
    
    def connect_to_device(self, device_string):
        """Connect to selected device"""
        # Parse device string
        # Format: "Device Name (address)"
        if "(" in device_string and ")" in device_string:
            address = device_string.split("(")[-1].split(")")[0]
            
            connection_type = self.connection_type.get()
            
            self.log_message(f"üîó Connecting to {address} via {connection_type}...")
            
            success = False
            if connection_type == "bluetooth":
                success = self.wisepad.connect_bluetooth(address)
            else:
                success = self.wisepad.connect_serial(address)
            
            if success:
                self.log_message("‚úÖ Connected successfully")
            else:
                self.log_message("‚ùå Connection failed")
            
            self.update_status()
    
    def clear_settings(self):
        """Clear all settings"""
        self.merchant_entry.delete(0, "end")
        self.terminal_entry.delete(0, "end")
        self.api_entry.delete(0, "end")
        self.device_combo.set("")
        
        self.wisepad.merchant_id = "THAIBARBER001"
        self.wisepad.terminal_id = "TP001"
        self.wisepad.api_key = None
        
        self.log_message("üßπ Settings cleared")
    
    def log_message(self, message):
        """Add message to log"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        self.log_text.insert("end", f"[{timestamp}] {message}\n")
        self.log_text.see("end")




################################# always keep at the end.

if __name__ == "__main__":
    app = HaircutStudioApp()
    app.mainloop()
###################################


  

    
        
    

